<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold Options Pro - Analytics</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-gold: #FFD700;
            --call-color: #2196F3;
            --put-color: #f44336;
            --strike-bg: #2c2c2c;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg-color); 
            color: var(--text-color); 
        }

        header {
            background: #333;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.5em;
            font-weight: bold;
            color: #fff;
        }

        .hero {
            background: linear-gradient(135deg, #000000 0%, #434343 100%);
            padding: 30px 20px;
            text-align: center;
            color: #fff;
        }

        .hero h1 {
            font-size: 2em;
            color: var(--accent-gold);
            margin-bottom: 5px;
        }

        .hero p {
            font-size: 1em;
            opacity: 0.8;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .status-warning {
            background: rgba(183, 28, 28, 0.1);
            border: 1px solid #b71c1c;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            color: #e57373;
        }

        .data-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .data-card {
            background: #222;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #333;
        }

        .data-card-label {
            color: #888;
            font-size: 0.8em;
            margin-bottom: 5px;
        }

        .data-card-value {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--accent-gold);
        }

        /* üî• –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ï –ö–ù–û–ü–ö–ò –≠–ö–°–ü–ò–†–ê–¶–ò–ò */
        .expiry-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 15px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
        }

        .expiry-btn {
            background: #333;
            color: #aaa;
            border: 1px solid #555;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 0.9em;
            white-space: nowrap;
        }

        .expiry-btn:hover {
            background: #444;
            border-color: #777;
        }

        .expiry-btn.active {
            background: var(--accent-gold);
            color: #000;
            border-color: var(--accent-gold);
            font-weight: bold;
        }

        .expiry-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .expiry-btn.disabled:hover {
            background: #333;
            border-color: #555;
        }

        /* –ê–ù–ê–õ–ò–¢–ò–ö–ê */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .analytics-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border: 1px solid #444;
            border-radius: 10px;
            padding: 20px;
            position: relative;
        }

        .analytics-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-gold);
            border-top-left-radius: 10px;
            border-bottom-left-radius: 10px;
        }

        .analytics-title {
            color: var(--accent-gold);
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .analytics-value {
            font-size: 2em;
            font-weight: bold;
            color: #fff;
            text-align: center;
            margin: 10px 0;
        }

        .analytics-label {
            color: #888;
            font-size: 0.85em;
            text-align: center;
        }

        /* –ì–†–ê–§–ò–ö–ò */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-box {
            background: #1a1a1a;
            border: 1px solid #444;
            padding: 20px;
            border-radius: 10px;
        }

        .chart-title {
            color: var(--accent-gold);
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
        }

        /* –¢–ê–ë–õ–ò–¶–ê */
        .table-container {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .table-header {
            background: #2c2c2c;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #444;
        }

        .table-header span {
            color: #888;
            font-size: 0.9em;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        thead {
            background: #222;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 10px;
            text-align: center;
            color: #aaa;
            font-weight: 600;
            white-space: nowrap;
            border-bottom: 1px solid #333;
        }

        td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid #2a2a2a;
        }

        .col-strike {
            background: var(--strike-bg);
            font-weight: bold;
            color: #fff;
            border-left: 1px solid #333;
            border-right: 1px solid #333;
            width: 80px;
        }

        .row-atm {
            background: rgba(255, 215, 0, 0.1);
            border-top: 1px solid var(--accent-gold);
            border-bottom: 1px solid var(--accent-gold);
        }

        tbody tr:hover {
            background: rgba(255, 215, 0, 0.05);
        }

        .call-strike {
            color: var(--call-color);
            font-weight: bold;
        }

        .put-strike {
            color: var(--put-color);
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        footer {
            background: #111;
            padding: 20px;
            text-align: center;
            color: #666;
            font-size: 0.8em;
            margin-top: 40px;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .hero h1 {
                font-size: 1.5em;
            }

            .expiry-buttons {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">üìä Gold Options Pro</div>
        <span style="color: #888; font-size: 0.9em;">Max Pain ‚Ä¢ Gamma Walls ‚Ä¢ Greeks ‚Ä¢ Real-time</span>
    </header>

    <section class="hero">
        <h1>Gold Analytics Pro</h1>
        <p>Real-time Options Chain Analytics</p>
    </section>

    <div class="container">

        <!-- STATUS -->
        <div class="status-warning">
            <strong>‚ö†Ô∏è –°–¢–ê–¢–£–° –î–ê–ù–ù–´–•</strong><br>
            <span id="connectionStatus">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase...</span>
        </div>

        <!-- DATA CARDS -->
        <div class="data-cards">
            <div class="data-card">
                <div class="data-card-label">–¶–µ–Ω–∞ (Live)</div>
                <div class="data-card-value" id="livePrice">...</div>
            </div>
            <div class="data-card">
                <div class="data-card-label">PCR (OI)</div>
                <div class="data-card-value" id="pcrOI">...</div>
            </div>
            <div class="data-card">
                <div class="data-card-label">PCR (Vol)</div>
                <div class="data-card-value" id="pcrVol">...</div>
            </div>
            <div class="data-card">
                <div class="data-card-label">–ë–∞–ª–∞–Ω—Å</div>
                <div class="data-card-value" id="balance">...</div>
            </div>
            <div class="data-card">
                <div class="data-card-label">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UTC</div>
                <div class="data-card-value" id="lastUpdate" style="font-size: 0.9em;">--:--:--</div>
            </div>
        </div>

        <!-- –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ï –ö–ù–û–ü–ö–ò –≠–ö–°–ü–ò–†–ê–¶–ò–ò -->
        <div class="expiry-buttons" id="expiryButtonsContainer">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–π...</div>
        </div>

        <!-- –ê–ù–ê–õ–ò–¢–ò–ö–ê -->
        <div class="analytics-grid">
            <div class="analytics-card">
                <div class="analytics-title">üéØ Max Pain</div>
                <div class="analytics-value" id="maxPain">-</div>
                <div class="analytics-label">–¢–æ—á–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –±–æ–ª–∏</div>
            </div>

            <div class="analytics-card">
                <div class="analytics-title">üìè Expected Move (¬±1œÉ)</div>
                <div class="analytics-value" id="expectedMove">-</div>
                <div class="analytics-label" id="expectedMoveRange">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>

            <div class="analytics-card">
                <div class="analytics-title">üéØ ITM Probability</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <div>
                        <div style="color: var(--call-color); font-weight: bold; font-size: 1.3em;" id="probCall">-</div>
                        <div style="font-size: 0.7em; color: #888;">CALL ITM</div>
                    </div>
                    <div>
                        <div style="color: var(--put-color); font-weight: bold; font-size: 1.3em;" id="probPut">-</div>
                        <div style="font-size: 0.7em; color: #888;">PUT ITM</div>
                    </div>
                </div>
            </div>

            <div class="analytics-card">
                <div class="analytics-title">‚ö° Zero Gamma</div>
                <div class="analytics-value" id="zeroGamma">-</div>
                <div class="analytics-label" id="zeroGammaLabel">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>

            <div class="analytics-card">
                <div class="analytics-title">üåÄ Vanna Exposure</div>
                <div class="analytics-value" id="vannaNet">-</div>
                <div class="analytics-label">Net Vanna</div>
            </div>

            <div class="analytics-card">
                <div class="analytics-title">Œì Total Gamma</div>
                <div class="analytics-value" id="totalGamma">-</div>
                <div class="analytics-label">–ì–∞–º–º–∞</div>
            </div>

            <div class="analytics-card">
                <div class="analytics-title">Œî Call Delta</div>
                <div class="analytics-value" id="callDelta">-</div>
                <div class="analytics-label">–î–µ–ª—å—Ç–∞ –ö–æ–ª–ª–æ–≤</div>
            </div>

            <div class="analytics-card">
                <div class="analytics-title">Œî Put Delta</div>
                <div class="analytics-value" id="putDelta">-</div>
                <div class="analytics-label">–î–µ–ª—å—Ç–∞ –ü—É—Ç–æ–≤</div>
            </div>
        </div>

        <!-- –ì–†–ê–§–ò–ö–ò -->
        <div class="charts-grid">
            <div class="chart-box">
                <div class="chart-title">üìä OI Distribution</div>
                <div class="chart-wrapper">
                    <canvas id="oiChart"></canvas>
                </div>
            </div>

            <div class="chart-box">
                <div class="chart-title">üìà Volume Heatmap</div>
                <div class="chart-wrapper">
                    <canvas id="volumeChart"></canvas>
                </div>
            </div>

            <div class="chart-box">
                <div class="chart-title">‚ö° Gamma Exposure (GEX)</div>
                <div class="chart-wrapper">
                    <canvas id="gammaChart"></canvas>
                </div>
            </div>

            <div class="chart-box">
                <div class="chart-title">üéØ Max Pain Curve</div>
                <div class="chart-wrapper">
                    <canvas id="maxPainChart"></canvas>
                </div>
            </div>
        </div>

        <!-- –¢–ê–ë–õ–ò–¶–ê -->
        <div class="table-container">
            <div class="table-header">
                <span id="tableExpiry">INTRADAY - Full Analytics</span>
                <span id="tableDataCount">0 strikes</span>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th colspan="5" style="border-bottom: 2px solid var(--call-color); color: var(--call-color);">CALLS</th>
                            <th style="background: var(--strike-bg); color: #fff;">STRIKE</th>
                            <th colspan="5" style="border-bottom: 2px solid var(--put-color); color: var(--put-color);">PUTS</th>
                        </tr>
                        <tr>
                            <th>OI</th><th>Vol</th><th>Prem</th><th>Œî</th><th>Œì</th>
                            <th style="background: var(--strike-bg);"></th>
                            <th>Œì</th><th>Œî</th><th>Prem</th><th>Vol</th><th>OI</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="11" class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <footer>
        <p>&copy; 2025 Gold Options Pro Analytics. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è "–∫–∞–∫ –µ—Å—Ç—å" –±–µ–∑ –≥–∞—Ä–∞–Ω—Ç–∏–π.</p>
    </footer>

    <script>
        // ============= FIREBASE CONFIG =============
        const firebaseConfig = {
            apiKey: "AIzaSyDcNzTlV-pE3PVfH76mKtxQ-0MgH5wxC0c",
            authDomain: "cmeparser.firebaseapp.com",
            databaseURL: "https://cmeparser-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "cmeparser",
            storageBucket: "cmeparser.appspot.com",
            messagingSenderId: "397819706532",
            appId: "1:397819706532:web:7f3fa7c9a06b5a3a3e1b6f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ============= –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =============
        let allDTEData = {}; // { dte_1: [...], dte_2: [...], ... }
        let currentDTE = null;
        let currentPrice = 2600;
        let chartsInstances = {};

        // ============= –ú–ï–¢–û–î–´ =============
        
        /**
         * üî• –ù–ê–ô–¢–ò –î–û–°–¢–£–ü–ù–´–ï –≠–ö–°–ü–ò–†–ê–¶–ò–ò –í FIREBASE
         */
        async function loadAvailableDTEs() {
            console.log('üîç –ò—â–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ DTE —É–∑–ª—ã...');
            
            const dteNodes = ['dte_1', 'dte_2', 'dte_3', 'dte_4', 'dte_5', 'dte_6', 'dte_7', 'dte_8', 'dte_9'];
            const available = {};

            for (const dteKey of dteNodes) {
                try {
                    const snapshot = await db.ref(dteKey).once('value');
                    const data = snapshot.val();

                    if (data && Array.isArray(data) && data.length > 0) {
                        available[dteKey] = data;
                        console.log(`‚úÖ ${dteKey}: ${data.length} strikes`);
                    } else if (data && typeof data === 'object' && Object.keys(data).length > 0) {
                        const arr = Object.values(data);
                        available[dteKey] = arr;
                        console.log(`‚úÖ ${dteKey}: ${arr.length} strikes`);
                    }
                } catch (e) {
                    console.log(`‚ö†Ô∏è ${dteKey} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω`);
                }
            }

            allDTEData = available;
            renderExpiryButtons();

            if (Object.keys(available).length > 0) {
                const firstDTE = Object.keys(available)[0];
                switchExpiry(firstDTE);
            }
        }

        /**
         * üî• –†–ï–ù–î–ï–† –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–• –ö–ù–û–ü–û–ö
         */
        function renderExpiryButtons() {
            const container = document.getElementById('expiryButtonsContainer');
            container.innerHTML = '';

            const dteLabels = {
                'dte_1': 'INTRADAY',
                'dte_2': 'FRIDAY',
                'dte_3': '3DTE',
                'dte_4': '4DTE',
                'dte_5': '5DTE',
                'dte_6': '6DTE',
                'dte_7': '7DTE',
                'dte_8': '8DTE',
                'dte_9': '9DTE'
            };

            Object.keys(allDTEData).forEach(dteKey => {
                const btn = document.createElement('button');
                btn.className = `expiry-btn ${currentDTE === dteKey ? 'active' : ''}`;
                btn.textContent = dteLabels[dteKey];
                btn.onclick = () => switchExpiry(dteKey);
                container.appendChild(btn);
            });

            // –ï—Å–ª–∏ –∫–Ω–æ–ø–æ–∫ –Ω–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (Object.keys(allDTEData).length === 0) {
                container.innerHTML = '<div class="loading">‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Firebase</div>';
            }
        }

        /**
         * üî• –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –≠–ö–°–ü–ò–†–ê–¶–ò–ò
         */
        function switchExpiry(dteKey) {
            if (!allDTEData[dteKey]) return;

            currentDTE = dteKey;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            document.querySelectorAll('.expiry-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target?.classList.add('active');

            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
            const data = allDTEData[dteKey];
            renderTable(data);
            calculateMetrics(data);
            createCharts(data);

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
            const dteLabels = {
                'dte_1': 'INTRADAY',
                'dte_2': 'FRIDAY',
                'dte_3': '3DTE',
                'dte_4': '4DTE',
                'dte_5': '5DTE',
                'dte_6': '6DTE',
                'dte_7': '7DTE',
                'dte_8': '8DTE',
                'dte_9': '9DTE'
            };
            document.getElementById('tableExpiry').textContent = `${dteLabels[dteKey]} - Full Analytics`;
            document.getElementById('tableDataCount').textContent = `${data.length} strikes`;
        }

        /**
         * üî• –†–ï–ù–î–ï–† –¢–ê–ë–õ–ò–¶–´
         */
        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="loading">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                return;
            }

            // –ù–∞–π—Ç–∏ ATM
            let atmIndex = 0;
            let minDiff = Infinity;
            data.forEach((row, idx) => {
                const strike = parseFloat(row.s);
                const diff = Math.abs(strike - currentPrice);
                if (diff < minDiff) {
                    minDiff = diff;
                    atmIndex = idx;
                }
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 75 —Å—Ç—Ä–∞–π–∫–æ–≤ —Å ATM –≤ —Ü–µ–Ω—Ç—Ä–µ
            const halfRange = 37;
            let startIdx = Math.max(0, atmIndex - halfRange);
            let endIdx = Math.min(data.length, startIdx + 75);
            if (endIdx - startIdx < 75) {
                startIdx = Math.max(0, endIdx - 75);
            }

            const displayData = data.slice(startIdx, endIdx);

            displayData.forEach((row, idx) => {
                const tr = document.createElement('tr');
                const isATM = (startIdx + idx) === atmIndex;

                const strike = parseFloat(row.s);
                const cOI = Math.round(row.c?.oi || 0);
                const cVol = Math.round(row.c?.vol || 0);
                const cPrem = (row.c?.pr || 0).toFixed(1);
                const cDelta = (row.c?.d || 0).toFixed(3);
                const cGamma = (row.c?.g || 0).toFixed(5);

                const pOI = Math.round(row.p?.oi || 0);
                const pVol = Math.round(row.p?.vol || 0);
                const pPrem = (row.p?.pr || 0).toFixed(1);
                const pDelta = (row.p?.d || 0).toFixed(3);
                const pGamma = (row.p?.g || 0).toFixed(5);

                const strikeColor = strike > currentPrice ? 'call-strike' : (strike < currentPrice ? 'put-strike' : '');

                tr.innerHTML = `
                    <td style="color: ${cOI > 100 ? '#4caf50' : '#888'}">${cOI}</td>
                    <td style="color: ${cVol > 100 ? '#4caf50' : '#888'}">${cVol}</td>
                    <td style="color: #aaa">${cPrem}</td>
                    <td style="color: var(--call-color)">${cDelta}</td>
                    <td style="color: #FFD700">${cGamma}</td>
                    
                    <td class="col-strike ${strikeColor}">${strike.toFixed(1)}</td>
                    
                    <td style="color: #FFD700">${pGamma}</td>
                    <td style="color: var(--put-color)">${pDelta}</td>
                    <td style="color: #aaa">${pPrem}</td>
                    <td style="color: ${pVol > 100 ? '#f44336' : '#888'}">${pVol}</td>
                    <td style="color: ${pOI > 100 ? '#f44336' : '#888'}">${pOI}</td>
                `;

                if (isATM) tr.classList.add('row-atm');
                tbody.appendChild(tr);
            });
        }

        /**
         * üî• –†–ê–°–ß–ï–¢ –ú–ï–¢–†–ò–ö
         */
        function calculateMetrics(data) {
            if (!data || data.length === 0) return;

            // MAX PAIN
            let maxPain = null;
            let minLoss = Infinity;
            data.forEach(testRow => {
                const testStrike = parseFloat(testRow.s);
                let totalLoss = 0;
                data.forEach(row => {
                    const strike = parseFloat(row.s);
                    const cOI = row.c?.oi || 0;
                    const pOI = row.p?.oi || 0;
                    if (testStrike > strike) totalLoss += (testStrike - strike) * cOI * 100;
                    if (testStrike < strike) totalLoss += (strike - testStrike) * pOI * 100;
                });
                if (totalLoss < minLoss) {
                    minLoss = totalLoss;
                    maxPain = testStrike;
                }
            });
            document.getElementById('maxPain').textContent = maxPain ? `$${maxPain.toFixed(1)}` : '-';

            // PCR
            let totalCallOI = 0, totalPutOI = 0;
            let totalCallVol = 0, totalPutVol = 0;
            data.forEach(row => {
                totalCallOI += row.c?.oi || 0;
                totalPutOI += row.p?.oi || 0;
                totalCallVol += row.c?.vol || 0;
                totalPutVol += row.p?.vol || 0;
            });
            const pcrOI = totalCallOI > 0 ? (totalPutOI / totalCallOI).toFixed(2) : '0.00';
            const pcrVol = totalCallVol > 0 ? (totalPutVol / totalCallVol).toFixed(2) : '0.00';
            document.getElementById('pcrOI').textContent = pcrOI;
            document.getElementById('pcrVol').textContent = pcrVol;

            // GREEKS
            let totalCallDelta = 0, totalPutDelta = 0, totalGamma = 0;
            data.forEach(row => {
                const cOI = row.c?.oi || 0;
                const pOI = row.p?.oi || 0;
                totalCallDelta += (row.c?.d || 0) * cOI;
                totalPutDelta += Math.abs(row.p?.d || 0) * pOI;
                totalGamma += ((row.c?.g || 0) + (row.p?.g || 0)) * (cOI + pOI) / 2;
            });
            document.getElementById('callDelta').textContent = (totalCallDelta / 1000).toFixed(1) + 'K';
            document.getElementById('putDelta').textContent = (totalPutDelta / 1000).toFixed(1) + 'K';
            document.getElementById('totalGamma').textContent = (totalGamma / 1000).toFixed(1) + 'K';

            // ITM PROBABILITY
            const atmRow = data.reduce((prev, curr) => {
                const pDiff = Math.abs(parseFloat(prev.s) - currentPrice);
                const cD= Math.abs(parseFloat(curr.s) - currentPrice);
return cD < pDiff ? curr : prev;
});
if (atmRow) {
document.getElementById('probCall').textContent = (Math.abs(atmRow.c?.d || 0.5) * 100).toFixed(1) + '%';
document.getElementById('probPut').textContent = (Math.abs(atmRow.p?.d || 0.5) * 100).toFixed(1) + '%';
}
        // BALANCE
        let balance = currentPrice;
        let totalWeight = 0;
        let weightedSum = 0;
        data.forEach(row => {
            const strike = parseFloat(row.s);
            const cWeight = (row.c?.oi || 0) * (row.c?.pr || 0);
            const pWeight = (row.p?.oi || 0) * (row.p?.pr || 0);
            if (cWeight > 0) {
                weightedSum += (strike + (row.c?.pr || 0)) * cWeight;
                totalWeight += cWeight;
            }
            if (pWeight > 0) {
                weightedSum += (strike - (row.p?.pr || 0)) * pWeight;
                totalWeight += pWeight;
            }
        });
        if (totalWeight > 0) balance = weightedSum / totalWeight;
        document.getElementById('balance').textContent = '$' + balance.toFixed(1);
    }

    /**
     * üî• –°–û–ó–î–ê–ù–ò–ï –ì–†–ê–§–ò–ö–û–í
     */
    function createCharts(data) {
        if (!data || data.length === 0) return;

        const strikes = data.map(r => parseFloat(r.s).toFixed(1));
        const callOI = data.map(r => r.c?.oi || 0);
        const putOI = data.map(r => r.p?.oi || 0);
        const callVol = data.map(r => r.c?.vol || 0);
        const putVol = data.map(r => r.p?.vol || 0);
        const gammaData = data.map(r => {
            const strike = parseFloat(r.s);
            const cGamma = (r.c?.g || 0) * (r.c?.oi || 0) * strike * 100;
            const pGamma = (r.p?.g || 0) * (r.p?.oi || 0) * strike * 100;
            return (cGamma - pGamma) / 1000000;
        });

        // OI Chart
        if (chartsInstances.oiChart) chartsInstances.oiChart.destroy();
        const ctxOI = document.getElementById('oiChart').getContext('2d');
        chartsInstances.oiChart = new Chart(ctxOI, {
            type: 'bar',
            data: {
                labels: strikes,
                datasets: [{
                    label: 'Call OI',
                    data: callOI,
                    backgroundColor: 'rgba(33, 150, 243, 0.7)',
                    borderWidth: 0
                }, {
                    label: 'Put OI',
                    data: putOI.map(v => -v),
                    backgroundColor: 'rgba(244, 67, 54, 0.7)',
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#fff' } } },
                scales: {
                    x: { ticks: { color: '#888', maxTicksLimit: 15 }, grid: { color: '#333' } },
                    y: { 
                        ticks: { color: '#888', callback: v => Math.abs(v) },
                        grid: { 
                            color: c => c.tick.value === 0 ? '#FFD700' : '#333',
                            lineWidth: c => c.tick.value === 0 ? 2 : 1
                        }
                    }
                }
            }
        });

        // Volume Chart
        if (chartsInstances.volumeChart) chartsInstances.volumeChart.destroy();
        const ctxVol = document.getElementById('volumeChart').getContext('2d');
        chartsInstances.volumeChart = new Chart(ctxVol, {
            type: 'bar',
            data: {
                labels: strikes,
                datasets: [{
                    label: 'Call Vol',
                    data: callVol,
                    backgroundColor: 'rgba(76, 175, 80, 0.7)',
                    borderWidth: 0
                }, {
                    label: 'Put Vol',
                    data: putVol.map(v => -v),
                    backgroundColor: 'rgba(255, 152, 0, 0.7)',
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#fff' } } },
                scales: {
                    x: { ticks: { color: '#888', maxTicksLimit: 15 }, grid: { color: '#333' } },
                    y: { 
                        ticks: { color: '#888', callback: v => Math.abs(v) },
                        grid: { color: '#333' }
                    }
                }
            }
        });

        // Gamma Chart
        if (chartsInstances.gammaChart) chartsInstances.gammaChart.destroy();
        const ctxGamma = document.getElementById('gammaChart').getContext('2d');
        chartsInstances.gammaChart = new Chart(ctxGamma, {
            type: 'line',
            data: {
                labels: strikes,
                datasets: [{
                    label: 'Net GEX',
                    data: gammaData,
                    backgroundColor: 'rgba(255, 215, 0, 0.2)',
                    borderColor: 'rgba(255, 215, 0, 1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#fff' } } },
                scales: {
                    x: { ticks: { color: '#888', maxTicksLimit: 15 }, grid: { color: '#333' } },
                    y: { ticks: { color: '#888' }, grid: { color: '#333' } }
                }
            }
        });

        // Max Pain Chart
        const maxPainData = strikes.map((testStrike, testIdx) => {
            let totalLoss = 0;
            data.forEach((row, idx) => {
                const strike = parseFloat(row.s);
                const ts = parseFloat(strikes[testIdx]);
                const cOI = row.c?.oi || 0;
                const pOI = row.p?.oi || 0;
                if (ts > strike) totalLoss += (ts - strike) * cOI * 100;
                if (ts < strike) totalLoss += (strike - ts) * pOI * 100;
            });
            return totalLoss / 1000000;
        });

        if (chartsInstances.maxPainChart) chartsInstances.maxPainChart.destroy();
        const ctxMaxPain = document.getElementById('maxPainChart').getContext('2d');
        chartsInstances.maxPainChart = new Chart(ctxMaxPain, {
            type: 'line',
            data: {
                labels: strikes,
                datasets: [{
                    label: 'Total Loss (M)',
                    data: maxPainData,
                    backgroundColor: 'rgba(183, 28, 28, 0.2)',
                    borderColor: 'rgba(183, 28, 28, 1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#fff' } } },
                scales: {
                    x: { ticks: { color: '#888', maxTicksLimit: 15 }, grid: { color: '#333' } },
                    y: { ticks: { color: '#888' }, grid: { color: '#333' } }
                }
            }
        });
    }

    /**
     * üî• WEBSOCKET –î–õ–Ø –†–ï–ê–õ-–¢–ê–ô–ú–ê
     */
    function connectWebSocket() {
        const ws = new WebSocket('wss://askhat777-gold-relay.hf.space/ws');

        ws.onopen = () => {
            console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
            document.getElementById('connectionStatus').innerHTML = 'üü¢ <strong>LIVE CONNECTION</strong>';
        };

        ws.onmessage = (event) => {
            try {
                const msg = JSON.parse(event.data);

                if (msg.type === 'price') {
                    currentPrice = parseFloat(msg.data.price);
                    document.getElementById('livePrice').textContent = '$' + currentPrice.toFixed(1);
                }

                if (msg.type === 'analytics') {
                    const analytics = msg.data;
                    if (analytics.updated_at) {
                        document.getElementById('lastUpdate').textContent = analytics.updated_at;
                    }
                }
            } catch (e) {
                console.error('WS –æ—à–∏–±–∫–∞:', e);
            }
        };

        ws.onerror = () => {
            document.getElementById('connectionStatus').innerHTML = 'üî¥ <strong>CONNECTION ERROR</strong>';
        };

        ws.onclose = () => {
            document.getElementById('connectionStatus').innerHTML = 'üü† <strong>DISCONNECTED</strong>';
            setTimeout(connectWebSocket, 3000);
        };
    }

    // ============= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =============
    document.addEventListener('DOMContentLoaded', () => {
        loadAvailableDTEs();
        connectWebSocket();
    });

</script>
</body>
</html>
