<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="description" content="–û–ø—Ü–∏–æ–Ω–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ Gold (CME). Max Pain, Gamma Walls, Charts.">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">

    <title>Gold Options - Pro Analytics</title>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-gold: #FFD700;
            --call-color: #2e7d32;
            --put-color: #c62828;
            --strike-bg: #2c2c2c;
        }
        
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; }
        a { text-decoration: none; color: inherit; }
        
        header { background: #333; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .logo { font-size: 1.5em; font-weight: bold; color: #fff; display: flex; align-items: center; gap: 10px; }
        .menu { list-style: none; display: flex; gap: 20px; padding: 0; margin: 0; }
        .menu a:hover { color: var(--accent-gold); }

        .hero { background: linear-gradient(135deg, #000000 0%, #434343 100%); padding: 40px 20px; text-align: center; color: #fff; }
        .hero h1 { margin: 0 0 5px 0; font-size: 2em; font-weight: 800; color: var(--accent-gold); }
        .subtitle { font-size: 1.1em; margin-bottom: 20px; opacity: 0.8; }
        .btn-primary { background: var(--accent-gold); color: #000; padding: 12px 30px; border-radius: 25px; font-weight: bold; transition: 0.3s; }
        .btn-primary:hover { background: #fff; }

        .live-data { padding: 20px; background: #000; }

        .warning-block {
            text-align: center; margin-bottom: 20px; 
            border: 1px solid #b71c1c; 
            background: rgba(183, 28, 28, 0.1); 
            padding: 15px; border-radius: 8px;
        }
        .warning-title { color: #e57373; font-size: 1em; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .warning-text { color: #ccc; font-size: 0.9em; margin: 0; }
        
        .data-container { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .data-card { background: #222; padding: 10px; border-radius: 8px; min-width: 140px; text-align: center; border: 1px solid #333; }
        .big-number { font-size: 1.3em; font-weight: bold; color: var(--accent-gold); margin: 5px 0; }
        .small-text { color: #888; font-size: 0.75em; }
        
        .pcr-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .pcr-item div:first-child { font-weight: bold; color: #fff; }
        .pcr-item div:last-child { font-size: 0.7em; color: #888; }

        /* –ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ò–ï –ë–õ–û–ö–ò */
        .analytics-grid {
            max-width: 1200px; margin: 0 auto 20px auto;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;
        }
        .analytics-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border: 1px solid #444; border-radius: 10px;
            padding: 20px; position: relative; overflow: hidden;
        }
        .analytics-card::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 4px; height: 100%; background: var(--accent-gold);
        }
        .analytics-title {
            font-size: 1.1em; font-weight: bold; color: var(--accent-gold);
            margin-bottom: 15px; display: flex; align-items: center; gap: 8px;
        }
        .analytics-value {
            font-size: 2em; font-weight: bold; color: #fff;
            text-align: center; margin: 10px 0;
        }
        .analytics-label {
            color: #888; font-size: 0.85em; text-align: center;
        }
        .level-item {
            background: #222; padding: 8px 12px; border-radius: 6px;
            margin: 5px 0; display: flex; justify-content: space-between;
            align-items: center; border-left: 3px solid transparent;
        }
        .level-item.support { border-left-color: var(--call-color); }
        .level-item.resistance { border-left-color: var(--put-color); }
        .level-strike { font-weight: bold; color: #fff; }
        .level-value { color: var(--accent-gold); font-weight: bold; }

        /* üî• –ì–†–ê–§–ò–ö–ò üî• */
        .charts-container {
            max-width: 1200px; margin: 0 auto 30px auto;
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
        }
        .chart-box {
            background: #1a1a1a; border: 1px solid #444;
            padding: 20px; border-radius: 10px;
            position: relative;
        }
        .chart-title {
            font-size: 1.2em; font-weight: bold; color: var(--accent-gold);
            margin-bottom: 15px; text-align: center;
        }
        .chart-wrapper {
            position: relative; height: 300px;
        }

        /* –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
        .control-panel {
            max-width: 1000px; margin: 0 auto 20px auto; 
            background: #1a1a1a; border: 1px solid #444;
            padding: 20px; border-radius: 10px;
            display: flex; flex-direction: column; gap: 15px;
        }

        .calculator-panel {
            display: flex; align-items: center; justify-content: center; gap: 15px;
            background: #2a2a2a; border: 1px solid var(--accent-gold);
            padding: 15px; border-radius: 8px;
        }
        .calc-input { 
            background: #111; border: 1px solid #555; color: var(--accent-gold); 
            padding: 10px; border-radius: 5px; width: 100px; 
            font-size: 1.2em; text-align: center; font-weight: bold; 
        }

        .strike-filter {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            flex-wrap: wrap;
        }
        .filter-label { color: #fff; font-weight: bold; }
        .filter-btn {
            background: #2a2a2a; color: #aaa; 
            border: 1px solid #555; padding: 8px 16px; 
            border-radius: 5px; cursor: pointer;
            transition: all 0.3s;
        }
        .filter-btn:hover { background: #333; }
        .filter-btn.active { 
            background: var(--accent-gold); 
            color: #000; 
            border-color: var(--accent-gold);
            font-weight: bold;
        }

        /* –¢–û–ü-5 */
        .top5-container {
            max-width: 1000px; margin: 0 auto 20px auto;
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        }
        .top5-box {
            background: #1a1a1a; border: 1px solid #444;
            padding: 15px; border-radius: 10px;
        }
        .top5-title {
            font-size: 1.1em; font-weight: bold; 
            color: var(--accent-gold);
            margin-bottom: 10px; text-align: center;
            border-bottom: 2px solid #333; padding-bottom: 8px;
        }
        .top5-grid { display: flex; flex-direction: column; gap: 8px; }
        .top5-item {
            background: #222; padding: 8px 12px; border-radius: 6px;
            display: flex; justify-content: space-between;
            align-items: center;
            border-left: 3px solid transparent;
        }
        .top5-item.call-item { border-left-color: var(--call-color); }
        .top5-item.put-item { border-left-color: var(--put-color); }
        .top5-strike { 
            font-weight: bold; color: #fff; 
            font-size: 1.1em; min-width: 70px;
        }
        .top5-value { 
            color: var(--accent-gold); font-weight: bold; 
            font-size: 1em;
        }

        /* –¢–ê–ë–õ–ò–¶–ê */
        .levels-container { 
            max-width: 1000px; margin: 0 auto; 
            background: #1a1a1a; border-radius: 8px; 
            overflow: hidden; border: 1px solid #333; 
        }
        .table-header-info { 
            background: #2c2c2c; padding: 8px 20px; 
            text-align: center; color: #fff; font-size: 0.9em; 
            border-bottom: 1px solid #444; 
            display: flex; justify-content: space-between; 
        }
        .dte-tag { 
            background: #d32f2f; color: white; 
            padding: 2px 6px; border-radius: 4px; 
            font-size: 0.8em; 
        }

        .table-wrapper { overflow-x: auto; max-height: 600px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; text-align: center; font-size: 0.85em; }
        thead { background: #111; color: #aaa; font-size: 0.9em; position: sticky; top: 0; z-index: 10; }
        th { padding: 8px 4px; font-weight: 600; white-space: nowrap; }
        td { padding: 6px 4px; border-bottom: 1px solid #2a2a2a; } 
        
        .col-strike { 
            background: #252525; color: #fff; 
            font-weight: bold; font-size: 1.1em; 
            border-left: 1px solid #333; 
            border-right: 1px solid #333; 
            width: 80px; 
        }
        .row-atm td { 
            background: rgba(255, 215, 0, 0.1); 
            border-top: 1px solid var(--accent-gold); 
            border-bottom: 1px solid var(--accent-gold); 
        }
        .forward-active { 
            color: var(--accent-gold) !important; 
            text-decoration: underline; 
        }

        /* –ì–†–ê–î–ê–¶–ò–Ø –¶–í–ï–¢–û–í */
        .val-0 { color: #333; }
        .val-1 { color: #666; }
        .val-2 { color: #999; }
        .val-3 { color: #ccc; font-weight: 500; }
        .val-4 { color: #fff; font-weight: bold; }
        .val-5 { color: #4fc3f7; font-weight: bold; font-size: 1.05em; }
        .val-6 { color: #FFD700; font-weight: bold; font-size: 1.1em; text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
        .val-7 { background: #b71c1c; color: #fff; font-weight: bold; padding: 4px; border-radius: 4px; }

        .download { padding: 40px 20px; text-align: center; }
        .download-card { 
            background: #222; padding: 30px; 
            display:inline-block; border-radius:10px; 
            border:1px solid #333; 
        }
        .btn-download { 
            background: var(--call-color); color: white; 
            padding: 15px 30px; border-radius: 5px; 
            display: inline-block; margin: 10px 0; 
            font-weight: bold; 
        }
        footer { 
            background: #111; padding: 20px; 
            text-align: center; color: #666; 
            font-size: 0.8em; 
        }

        @media (max-width: 768px) {
            .menu { display: none; }
            .calculator-panel, .strike-filter { flex-direction: column; }
            .top5-container, .analytics-grid, .charts-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo"><span>üìä</span> Gold Options</div>
        <ul class="menu">
            <li><a href="#charts">–ì—Ä–∞—Ñ–∏–∫–∏</a></li>
            <li><a href="#analytics">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a></li>
            <li><a href="#top5">–¢–û–ü-5</a></li>
            <li><a href="#download">APK</a></li>
        </ul>
    </header>

    <section class="hero">
        <h1>Gold Analytics Pro</h1>
        <p class="subtitle">Max Pain ‚Ä¢ Gamma Walls ‚Ä¢ Interactive Charts</p>
        <a href="#download" class="btn-primary">–°–∫–∞—á–∞—Ç—å Android APK</a>
    </section>

    <section class="live-data">
        
        <div class="warning-block">
            <div class="warning-title">‚ö† –°–¢–ê–¢–£–° –î–ê–ù–ù–´–•</div>
            <p class="warning-text">
                –û–ø—Ü–∏–æ–Ω–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 5 –º–∏–Ω—É—Ç.<br>
                –¶–µ–Ω–∞ —Ñ—å—é—á–µ—Ä—Å–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–æ 5 —Å–µ–∫—É–Ω–¥.
            </p>
        </div>
        
        <div class="data-container">
            <div class="data-card">
                <div class="small-text">–¶–µ–Ω–∞ (Live)</div>
                <div class="big-number" id="futures-price">...</div>
            </div>
            
            <div class="data-card" style="min-width: 180px;">
                <div class="pcr-grid">
                    <div class="pcr-item">
                        <div id="pcr-oi">...</div>
                        <div>PCR (OI)</div>
                    </div>
                    <div class="pcr-item">
                        <div id="pcr-vol">...</div>
                        <div>PCR (Vol)</div>
                    </div>
                </div>
            </div>
            
            <div class="data-card">
                <div class="small-text">–ë–∞–ª–∞–Ω—Å</div>
                <div class="big-number" id="balance-price">...</div>
            </div>
            <div class="data-card">
                <div class="small-text">Updated UTC</div>
                <div class="big-number" id="updated-time">--:--</div>
            </div>
        </div>

        <!-- üî• –ì–†–ê–§–ò–ö–ò üî• -->
        <div id="charts" class="charts-container">
            <div class="chart-box">
                <div class="chart-title">üìä OI Distribution (Call vs Put)</div>
                <div class="chart-wrapper">
                    <canvas id="oiChart"></canvas>
                </div>
            </div>

            <div class="chart-box">
                <div class="chart-title">üìà Volume Heatmap</div>
                <div class="chart-wrapper">
                    <canvas id="volumeChart"></canvas>
                </div>
            </div>

            <div class="chart-box">
                <div class="chart-title">‚ö° Gamma Exposure</div>
                <div class="chart-wrapper">
                    <canvas id="gammaChart"></canvas>
                </div>
            </div>

            <div class="chart-box">
                <div class="chart-title">üéØ Max Pain Analysis</div>
                <div class="chart-wrapper">
                    <canvas id="maxPainChart"></canvas>
                </div>
            </div>
        </div>

        <!-- –ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ò–ï –ë–õ–û–ö–ò -->
        <div id="analytics" class="analytics-grid">
            <div class="analytics-card">
                <div class="analytics-title">üéØ Max Pain</div>
                <div class="analytics-value" id="max-pain-value">-</div>
                <div class="analytics-label">–¢–æ—á–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –±–æ–ª–∏</div>
            </div>

            <div class="analytics-card">
                <div class="analytics-title">‚ö° Gamma Walls</div>
                <div id="gamma-levels" style="margin-top: 10px;">
                    <div class="analytics-label">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>

            <div class="analytics-card">
                <div class="analytics-title">üî• Unusual Activity</div>
                <div id="unusual-activity" style="margin-top: 10px;">
                    <div class="analytics-label">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>

            <div class="analytics-card">
                <div class="analytics-title">üìç Key Levels (OI)</div>
                <div id="key-levels" style="margin-top: 10px;">
                    <div class="analytics-label">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
        </div>

        <div class="control-panel">
            <div class="calculator-panel">
                <label style="color:#fff; font-weight:bold;">Forward (–§–æ—Ä–≤–∞—Ä–¥):</label>
                <input type="number" id="forward-input" class="calc-input" placeholder="0" step="0.5" value="0">
            </div>

            <div class="strike-filter">
                <span class="filter-label">–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä–∞–π–∫–æ–≤:</span>
                <button class="filter-btn" data-count="50">50</button>
                <button class="filter-btn active" data-count="75">75</button>
                <button class="filter-btn" data-count="100">100</button>
                <button class="filter-btn" data-count="125">125</button>
                <button class="filter-btn" data-count="150">150</button>
            </div>
        </div>

        <div id="top5" class="top5-container">
            <div class="top5-box">
                <div class="top5-title">üü¢ CALLS - –¢–û–ü-5</div>
                <div class="top5-grid">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <div style="color: #888; font-size: 0.85em; margin-bottom: 8px; text-align: center;">–ü–æ Volume</div>
                            <div id="top5-call-vol"></div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 0.85em; margin-bottom: 8px; text-align: center;">–ü–æ OI</div>
                            <div id="top5-call-oi"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="top5-box">
                <div class="top5-title">üî¥ PUTS - –¢–û–ü-5</div>
                <div class="top5-grid">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <div style="color: #888; font-size: 0.85em; margin-bottom: 8px; text-align: center;">–ü–æ Volume</div>
                            <div id="top5-put-vol"></div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 0.85em; margin-bottom: 8px; text-align: center;">–ü–æ OI</div>
                            <div id="top5-put-oi"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="levels-container">
            <div class="table-header-info">
                <span>INTRADAY <span class="dte-tag">0DTE</span></span>
                <span style="color:#888;">Full Analytics Active</span>
            </div>
            
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th colspan="3" style="border-bottom: 2px solid var(--call-color);">CALLS</th>
                            <th style="background:#222;"></th>
                            <th colspan="3" style="border-bottom: 2px solid var(--put-color);">PUTS</th>
                        </tr>
                        <tr>
                            <th>OI</th><th>Vol</th><th>Prem</th>
                            <th style="background:#333; color:#fff;">STRIKE</th>
                            <th>Prem</th><th>Vol</th><th>OI</th>
                        </tr>
                    </thead>
                    <tbody id="option-body">
                        <tr><td colspan="7" style="padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="download" class="download">
        <h2>–°–∫–∞—á–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h2>
        <div class="download-card">
            <h3>Android APK</h3>
            <p style="color:#888;">–í–µ—Ä—Å–∏—è 1.0</p>
            <a href="downloads/gold-options.apk" download class="btn-download">üì• –°–∫–∞—á–∞—Ç—å APK</a>
        </div>
    </section>

    <footer>
        <p>&copy; 2025 Gold Options Pro Analytics.</p>
    </footer>

    <script>
        const DB_ROOT = "https://cmeparser-default-rtdb.europe-west1.firebasedatabase.app";
        
        let currentFuturesPrice = 0;
        let cachedTableData = []; 
        let forwardCorrection = 0;
        let displayStrikeCount = 75;

        // üî• –ì–†–ê–§–ò–ö–ò üî•
        let oiChart, volumeChart, gammaChart, maxPainChart;

        function getValueClass(value) {
            if (value === 0) return 'val-0';
            if (value < 50) return 'val-1';
            if (value < 100) return 'val-2';
            if (value < 500) return 'val-3';
            if (value < 1000) return 'val-4';
            if (value < 2000) return 'val-5';
            if (value < 5000) return 'val-6';
            return 'val-7';
        }

        // üî• –°–û–ó–î–ê–ù–ò–ï –ì–†–ê–§–ò–ö–û–í üî•
        function createCharts(data) {
            const strikes = data.map(r => r.strike);
            const callOI = data.map(r => r.call?.oi || 0);
            const putOI = data.map(r => r.put?.oi || 0);
            const callVol = data.map(r => r.call?.vol || 0);
            const putVol = data.map(r => r.put?.vol || 0);

            // –ì—Ä–∞—Ñ–∏–∫ OI Distribution
            if (oiChart) oiChart.destroy();
            const ctxOI = document.getElementById('oiChart').getContext('2d');
            oiChart = new Chart(ctxOI, {
                type: 'bar',
                data: {
                    labels: strikes,
                    datasets: [{
                        label: 'Call OI',
                        data: callOI,
                        backgroundColor: 'rgba(46, 125, 50, 0.7)',
                        borderColor: 'rgba(46, 125, 50, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Put OI',
                        data: putOI.map(v => -v),
                        backgroundColor: 'rgba(198, 40, 40, 0.7)',
                        borderColor: 'rgba(198, 40, 40, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#888', maxRotation: 45 },
                            grid: { color: '#333' }
                        },
                        y: { 
                            ticks: { color: '#888' },
                            grid: { color: '#333' }
                        }
                    }
                }
            });

            // –ì—Ä–∞—Ñ–∏–∫ Volume Heatmap
            if (volumeChart) volumeChart.destroy();
            const ctxVol = document.getElementById('volumeChart').getContext('2d');
            volumeChart = new Chart(ctxVol, {
                type: 'bar',
                data: {
                    labels: strikes,
                    datasets: [{
                        label: 'Call Vol',
                        data: callVol,
                        backgroundColor: 'rgba(79, 195, 247, 0.7)',
                        borderColor: 'rgba(79, 195, 247, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Put Vol',
                        data: putVol.map(v => -v),
                        backgroundColor: 'rgba(255, 138, 101, 0.7)',
                        borderColor: 'rgba(255, 138, 101, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#888', maxRotation: 45 },
                            grid: { color: '#333' }
                        },
                        y: { 
                            ticks: { color: '#888' },
                            grid: { color: '#333' }
                        }
                    }
                }
            });

            // –ì—Ä–∞—Ñ–∏–∫ Gamma Exposure
            const gammaData = data.map(r => {
                const strike = parseFloat(r.strike);
                const callOI = r.call?.oi || 0;
                const putOI = r.put?.oi || 0;
                return (callOI - putOI) * strike / 1000;
            });

            if (gammaChart) gammaChart.destroy();
            const ctxGamma = document.getElementById('gammaChart').getContext('2d');
            gammaChart = new Chart(ctxGamma, {
                type: 'line',
                data: {
                    labels: strikes,
                    datasets: [{
                        label: 'Gamma Exposure',
                        data: gammaData,
                        backgroundColor: 'rgba(255, 215, 0, 0.2)',
                        borderColor: 'rgba(255, 215, 0, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#888', maxRotation: 45 },
                            grid: { color: '#333' }
                        },
                        y: { 
                            ticks: { color: '#888' },
                            grid: { color: '#333' }
                        }
                    }
                }
            });

            // –ì—Ä–∞—Ñ–∏–∫ Max Pain
            const maxPainData = strikes.map(testStrike => {
                let totalLoss = 0;
                data.forEach(s => {
                    const strike = parseFloat(s.strike);
                    const callOI = s.call?.oi || 0;
                    const putOI = s.put?.oi || 0;
                    
                    if (testStrike > strike) {
                        totalLoss += (testStrike - strike) * callOI * 100;
                    }
                    if (testStrike < strike) {
                        totalLoss += (strike - testStrike) * putOI * 100;
                    }
                });
                return totalLoss / 1000000;
            });

            if (maxPainChart) maxPainChart.destroy();
            const ctxMaxPain = document.getElementById('maxPainChart').getContext('2d');
maxPainChart = new Chart(ctxMaxPain, {
type: 'line',
data: {
labels: strikes,
datasets: [{
label: 'Total Loss (M)',
data: maxPainData,
backgroundColor: 'rgba(183, 28, 28, 0.2)',
borderColor: 'rgba(183, 28, 28, 1)',
borderWidth: 2,
fill: true,
tension: 0.4
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: { labels: { color: '#fff' } }
},
scales: {
x: {
ticks: { color: '#888', maxRotation: 45 },
grid: { color: '#333' }
},
y: {
ticks: { color: '#888' },
grid: { color: '#333' }
}
}
}
});
}
    // MAX PAIN
    function calculateMaxPain(data) {
        const maxPainValues = {};
        
        data.forEach(strikeData => {
            const testStrike = parseFloat(strikeData.strike);
            let totalLoss = 0;
            
            data.forEach(s => {
                const strike = parseFloat(s.strike);
                const callOI = s.call?.oi || 0;
                const putOI = s.put?.oi || 0;
                
                if (testStrike > strike) {
                    totalLoss += (testStrike - strike) * callOI * 100;
                }
                if (testStrike < strike) {
                    totalLoss += (strike - testStrike) * putOI * 100;
                }
            });
            
            maxPainValues[testStrike] = totalLoss;
        });
        
        const maxPain = Object.keys(maxPainValues).reduce((a, b) => 
            maxPainValues[a] < maxPainValues[b] ? a : b
        );
        
        document.getElementById('max-pain-value').innerText = '$' + maxPain;
    }

    // GAMMA LEVELS
    function calculateGammaLevels(data) {
        const gammaLevels = data.map(row => {
            const strike = parseFloat(row.strike);
            const callOI = row.call?.oi || 0;
            const putOI = row.put?.oi || 0;
            
            const gammaExposure = (callOI - putOI) * strike;
            
            return {
                strike: strike,
                gamma: gammaExposure,
                type: gammaExposure > 0 ? 'support' : 'resistance'
            };
        });
        
        gammaLevels.sort((a, b) => Math.abs(b.gamma) - Math.abs(a.gamma));
        
        const html = gammaLevels.slice(0, 3).map(level => `
            <div class="level-item ${level.type}">
                <span class="level-strike">$${level.strike}</span>
                <span class="level-value">${level.type === 'support' ? 'üü¢' : 'üî¥'} ${Math.abs(level.gamma).toFixed(0)}</span>
            </div>
        `).join('');
        
        document.getElementById('gamma-levels').innerHTML = html;
    }

    // UNUSUAL ACTIVITY
    function findUnusualActivity(data) {
        const avgCallVol = data.reduce((sum, r) => sum + (r.call?.vol || 0), 0) / data.length;
        const avgPutVol = data.reduce((sum, r) => sum + (r.put?.vol || 0), 0) / data.length;
        
        const unusual = [];
        
        data.forEach(row => {
            const strike = row.strike;
            const callVol = row.call?.vol || 0;
            const putVol = row.put?.vol || 0;
            const callOI = row.call?.oi || 0;
            const putOI = row.put?.oi || 0;
            
            if (callVol > avgCallVol * 2.5 && callOI > 50) {
                unusual.push({
                    strike: strike,
                    type: 'CALL',
                    volume: callVol,
                    oi: callOI
                });
            }
            
            if (putVol > avgPutVol * 2.5 && putOI > 50) {
                unusual.push({
                    strike: strike,
                    type: 'PUT',
                    volume: putVol,
                    oi: putOI
                });
            }
        });
        
        unusual.sort((a, b) => b.volume - a.volume);
        
        const html = unusual.slice(0, 3).map(item => `
            <div class="level-item ${item.type === 'CALL' ? 'support' : 'resistance'}">
                <span class="level-strike">$${item.strike} ${item.type === 'CALL' ? 'üü¢' : 'üî¥'}</span>
                <span class="level-value">Vol: ${item.volume}</span>
            </div>
        `).join('');
        
        document.getElementById('unusual-activity').innerHTML = html || '<div class="analytics-label">–ù–µ—Ç –Ω–µ–æ–±—ã—á–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>';
    }

    // KEY LEVELS
    function calculateKeyLevels(data) {
        const levels = data.map(row => ({
            strike: parseFloat(row.strike),
            totalOI: (row.call?.oi || 0) + (row.put?.oi || 0),
            callOI: row.call?.oi || 0,
            putOI: row.put?.oi || 0
        }));
        
        levels.sort((a, b) => b.totalOI - a.totalOI);
        
        const html = levels.slice(0, 3).map(level => `
            <div class="level-item">
                <span class="level-strike">$${level.strike}</span>
                <span class="level-value">${level.totalOI}</span>
            </div>
        `).join('');
        
        document.getElementById('key-levels').innerHTML = html;
    }

    document.getElementById('forward-input').addEventListener('input', function(e) {
        const val = parseFloat(e.target.value);
        forwardCorrection = isNaN(val) ? 0 : val;
        if (cachedTableData.length > 0) {
            renderTable(cachedTableData);
            updateTop5(cachedTableData);
        }
    });

    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            displayStrikeCount = parseInt(this.dataset.count);
            if (cachedTableData.length > 0) renderTable(cachedTableData);
        });
    });

    async function fetchFastPrice() {
        try {
            const res = await fetch(`${DB_ROOT}/gold_fast.json`);
            const data = await res.json();
            if (data && data.price) {
                currentFuturesPrice = data.price;
                document.getElementById('futures-price').innerText = '$' + data.price.toFixed(1);
                if (cachedTableData.length > 0) renderTable(cachedTableData);
            }
        } catch (e) { console.error(e); }
    }

    async function fetchHeavyData() {
        try {
            const res = await fetch(`${DB_ROOT}/gold_heavy.json`);
            const data = await res.json();
            
            if (!data) return;

            document.getElementById('balance-price').innerText = '$' + data.balance_price;
            document.getElementById('updated-time').innerText = data.updated_at_utc;
            
            cachedTableData = data.data || [];
            
            calculatePCR(cachedTableData);
            calculateMaxPain(cachedTableData);
            calculateGammaLevels(cachedTableData);
            findUnusualActivity(cachedTableData);
            calculateKeyLevels(cachedTableData);
            createCharts(cachedTableData);
            renderTable(cachedTableData);
            updateTop5(cachedTableData);

        } catch (e) { console.error("–û—à–∏–±–∫–∞:", e); }
    }

    function calculatePCR(rows) {
        let totalPutOI = 0, totalCallOI = 0;
        let totalPutVol = 0, totalCallVol = 0;

        rows.forEach(r => {
            if(r.put) {
                totalPutOI += (r.put.oi || 0);
                totalPutVol += (r.put.vol || 0);
            }
            if(r.call) {
                totalCallOI += (r.call.oi || 0);
                totalCallVol += (r.call.vol || 0);
            }
        });
        
        let pcrOI = totalCallOI > 0 ? (totalPutOI / totalCallOI).toFixed(2) : "0.00";
        let pcrVol = totalCallVol > 0 ? (totalPutVol / totalCallVol).toFixed(2) : "0.00";
        
        document.getElementById('pcr-oi').innerText = pcrOI;
        document.getElementById('pcr-vol').innerText = pcrVol;
        
        colorPCR('pcr-oi', parseFloat(pcrOI));
        colorPCR('pcr-vol', parseFloat(pcrVol));
    }

    function colorPCR(elementId, value) {
        const el = document.getElementById(elementId);
        if(value > 1.0) el.style.color = "#f44336";
        else if(value < 0.7) el.style.color = "#4caf50";
        else el.style.color = "#fff";
    }

    function updateTop5(rows) {
        const callsVol = [...rows].sort((a, b) => (b.call?.vol || 0) - (a.call?.vol || 0)).slice(0, 5);
        const callsOI = [...rows].sort((a, b) => (b.call?.oi || 0) - (a.call?.oi || 0)).slice(0, 5);
        const putsVol = [...rows].sort((a, b) => (b.put?.vol || 0) - (a.put?.vol || 0)).slice(0, 5);
        const putsOI = [...rows].sort((a, b) => (b.put?.oi || 0) - (a.put?.oi || 0)).slice(0, 5);

        document.getElementById('top5-call-vol').innerHTML = callsVol.map(r => {
            const strike = parseFloat(r.strike) + forwardCorrection;
            return `<div class="top5-item call-item">
                <span class="top5-strike">${Number.isInteger(strike) ? strike : strike.toFixed(1)}</span>
                <span class="top5-value">${r.call?.vol || 0}</span>
            </div>`;
        }).join('');

        document.getElementById('top5-call-oi').innerHTML = callsOI.map(r => {
            const strike = parseFloat(r.strike) + forwardCorrection;
            return `<div class="top5-item call-item">
                <span class="top5-strike">${Number.isInteger(strike) ? strike : strike.toFixed(1)}</span>
                <span class="top5-value">${r.call?.oi || 0}</span>
            </div>`;
        }).join('');

        document.getElementById('top5-put-vol').innerHTML = putsVol.map(r => {
            const strike = parseFloat(r.strike) + forwardCorrection;
            return `<div class="top5-item put-item">
                <span class="top5-strike">${Number.isInteger(strike) ? strike : strike.toFixed(1)}</span>
                <span class="top5-value">${r.put?.vol || 0}</span>
            </div>`;
        }).join('');

        document.getElementById('top5-put-oi').innerHTML = putsOI.map(r => {
            const strike = parseFloat(r.strike) + forwardCorrection;
            return `<div class="top5-item put-item">
                <span class="top5-strike">${Number.isInteger(strike) ? strike : strike.toFixed(1)}</span>
                <span class="top5-value">${r.put?.oi || 0}</span>
            </div>`;
        }).join('');
    }

    function renderTable(rows) {
        const tbody = document.getElementById('option-body');
        tbody.innerHTML = '';
        
        if (!rows || rows.length === 0) return;

        let closestIndex = 0;
        let minDiff = Infinity;

        rows.forEach((row, idx) => {
            const displayStrike = parseFloat(row.strike) + forwardCorrection;
            const diff = Math.abs(displayStrike - currentFuturesPrice);
            if (diff < minDiff) {
                minDiff = diff;
                closestIndex = idx;
            }
        });

        const halfRange = Math.floor(displayStrikeCount / 2);
        let startIdx = Math.max(0, closestIndex - halfRange);
        let endIdx = Math.min(rows.length, startIdx + displayStrikeCount);

        if (endIdx - startIdx < displayStrikeCount) {
            startIdx = Math.max(0, endIdx - displayStrikeCount);
        }

        const displayRows = rows.slice(startIdx, endIdx);

        displayRows.forEach((row, idx) => {
            const tr = document.createElement('tr');
            
            const displayStrike = parseFloat(row.strike) + forwardCorrection;
            const isATM = (startIdx + idx) === closestIndex;

            const c_oi = row.call?.oi || 0;
            const c_vol = row.call?.vol || 0;
            const c_prem = row.call?.premium || 0;
            const p_oi = row.put?.oi || 0;
            const p_vol = row.put?.vol || 0;
            const p_prem = row.put?.premium || 0;

            const strikeClass = forwardCorrection !== 0 ? 'col-strike forward-active' : 'col-strike';

            tr.innerHTML = `
                <td class="${getValueClass(c_oi)}">${c_oi}</td>
                <td class="${getValueClass(c_vol)}">${c_vol}</td>
                <td style="color:#aaa;">${c_prem}</td>
                
                <td class="${strikeClass}">
                    ${Number.isInteger(displayStrike) ? displayStrike : displayStrike.toFixed(1)}
                </td>
                
                <td style="color:#aaa;">${p_prem}</td>
                <td class="${getValueClass(p_vol)}">${p_vol}</td>
                <td class="${getValueClass(p_oi)}">${p_oi}</td>
            `;

            if (isATM) tr.classList.add('row-atm');
            
            tbody.appendChild(tr);
        });
    }

    fetchFastPrice();
    fetchHeavyData();
    setInterval(fetchFastPrice, 2000);   
    setInterval(fetchHeavyData, 300000); 
</script>
</body>
</html>

