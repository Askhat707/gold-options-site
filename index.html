<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold Options - Pro Analytics</title>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-gold: #FFD700;
            --call-color: #2e7d32;
            --put-color: #c62828;
            --strike-bg: #2c2c2c;
            --bullish: #4caf50;
            --bearish: #f44336;
            --neutral: #9e9e9e;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-color); line-height: 1.6; }
        a { text-decoration: none; color: inherit; }
        
        /* üî• –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ü–û–î–°–ö–ê–ó–ö–ò */
        .chart-box, .analytics-card {
            position: relative;
            overflow: visible !important;
            z-index: 1;
        }

        .chart-title, .analytics-title {
            display: flex; justify-content: center; align-items: center; flex-wrap: wrap;
            position: relative; z-index: 10;
            font-size: 1.1em; font-weight: bold; color: var(--accent-gold);
            margin-bottom: 15px; text-align: center;
        }

        .chart-help, .analytics-help {
            position: relative; display: inline-block; cursor: help;
            margin-left: 8px; font-size: 1.1em; color: var(--accent-gold); z-index: 20;
        }

        .chart-annotation, .analytics-annotation {
            visibility: hidden; opacity: 0;
            position: absolute; bottom: 140%; left: 50%; transform: translateX(-50%);
            width: 260px; background: rgba(15, 15, 15, 0.98);
            border: 1px solid var(--accent-gold); box-shadow: 0 5px 20px rgba(0,0,0,0.8);
            border-radius: 8px; padding: 12px 15px;
            color: #eee; font-size: 0.85rem; font-weight: normal; line-height: 1.4;
            text-align: left; white-space: normal;
            transition: all 0.2s ease-in-out; pointer-events: none; z-index: 99999;
        }

        .chart-help:hover .chart-annotation, 
        .analytics-help:hover .analytics-annotation {
            visibility: visible; opacity: 1; bottom: 125%;
        }

        /* –î–ò–ó–ê–ô–ù */
        header { background: #333; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .logo { font-size: 1.5em; font-weight: bold; color: #fff; display: flex; align-items: center; gap: 10px; }
        .menu { list-style: none; display: flex; gap: 20px; }
        .menu a:hover { color: var(--accent-gold); }
        .tg-link-small { background: #24A1DE; padding: 5px 12px; border-radius: 15px; display: flex; align-items: center; gap: 5px; font-size: 0.8em; color: white; }

        .hero { background: linear-gradient(135deg, #000000 0%, #434343 100%); padding: 40px 20px; text-align: center; color: #fff; }
        .hero h1 { margin: 0 0 5px 0; font-size: 2em; font-weight: 800; color: var(--accent-gold); }
        .subtitle { font-size: 1.1em; margin-bottom: 20px; opacity: 0.8; }
        .btn { padding: 12px 25px; border-radius: 25px; font-weight: bold; transition: 0.3s; display: inline-flex; align-items: center; gap: 10px; border: none; cursor: pointer; text-decoration: none; }
        .btn-primary { background: var(--accent-gold); color: #000; }
        .btn-telegram { background: #24A1DE; color: white; }

        .live-data { padding: 20px; background: #000; }
        .warning-block { text-align: center; margin-bottom: 20px; border: 1px solid #b71c1c; background: rgba(183, 28, 28, 0.1); padding: 15px; border-radius: 8px; }
        .alerts-container { max-width: 1200px; margin: 0 auto 20px auto; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .alert { padding: 12px 20px; border-radius: 8px; font-weight: bold; font-size: 0.9em; border-left: 4px solid; }
        .alert-warning { background: rgba(255, 152, 0, 0.1); border-color: #ff9800; color: #ffb74d; }
        .alert-danger { background: rgba(244, 67, 54, 0.1); border-color: #f44336; color: #ef5350; }
        .alert-success { background: rgba(76, 175, 80, 0.1); border-color: #4caf50; color: #66bb6a; }

        .data-container { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .data-card { background: #222; padding: 10px; border-radius: 8px; min-width: 140px; text-align: center; border: 1px solid #333; }
        .big-number { font-size: 1.3em; font-weight: bold; color: var(--accent-gold); margin: 5px 0; }
        .pcr-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }

        .analytics-grid { max-width: 1200px; margin: 0 auto 20px auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .analytics-card { background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); border: 1px solid #444; border-radius: 10px; padding: 20px; }
        .analytics-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--accent-gold); }
        .analytics-value { font-size: 2em; font-weight: bold; color: #fff; text-align: center; margin: 10px 0; }
        .analytics-label { color: #888; font-size: 0.85em; text-align: center; }

        .level-item { background: #222; padding: 8px 12px; border-radius: 6px; margin: 5px 0; display: flex; justify-content: space-between; border-left: 3px solid transparent; }
        .level-item.support { border-left-color: var(--call-color); }
        .level-item.resistance { border-left-color: var(--put-color); }

        .charts-container { max-width: 1200px; margin: 0 auto 30px auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-box { background: #1a1a1a; border: 1px solid #444; padding: 20px; border-radius: 10px; }
        .chart-wrapper { position: relative; height: 300px; }

        .sentiment-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9em; text-transform: uppercase; }
        .sentiment-bullish { background: var(--bullish); color: #fff; }
        .sentiment-bearish { background: var(--bearish); color: #fff; }
        .sentiment-neutral { background: var(--neutral); color: #fff; }

        .risk-bar { width: 100%; height: 20px; background: #333; border-radius: 10px; overflow: hidden; position: relative; }
        .risk-fill { height: 100%; transition: width 0.5s ease; }
        .risk-low { background: var(--bullish); }
        .risk-medium { background: #ff9800; }
        .risk-high { background: var(--bearish); }

        .control-panel { max-width: 1000px; margin: 0 auto 20px auto; background: #1a1a1a; border: 1px solid #444; padding: 20px; border-radius: 10px; display: flex; flex-direction: column; gap: 15px; }
        .expiry-toggle, .calculator-panel, .strike-filter { display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .expiry-btn, .filter-btn { background: #333; color: #aaa; border: 1px solid #555; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        .expiry-btn.active, .filter-btn.active { background: var(--accent-gold); color: #000; border-color: var(--accent-gold); }
        .calc-input { background: #111; border: 1px solid #555; color: var(--accent-gold); padding: 10px; border-radius: 5px; width: 100px; text-align: center; font-weight: bold; }
        .premium-btn { background: #d32f2f; color: white; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .premium-btn.active { background: #4caf50; }

        .top5-container { max-width: 1000px; margin: 0 auto 20px auto; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .top5-box { background: #1a1a1a; border: 1px solid #444; padding: 15px; border-radius: 10px; }
        .top5-title { font-size: 1.1em; font-weight: bold; color: var(--accent-gold); margin-bottom: 10px; text-align: center; border-bottom: 2px solid #333; }
        .top5-item { background: #222; padding: 8px 12px; border-radius: 6px; display: flex; justify-content: space-between; margin-bottom: 5px; border-left: 3px solid transparent; }
        .top5-item.call-item { border-left-color: var(--call-color); }
        .top5-item.put-item { border-left-color: var(--put-color); }

        .levels-container { max-width: 1000px; margin: 0 auto; background: #1a1a1a; border-radius: 8px; overflow: hidden; border: 1px solid #333; }
        .table-wrapper { overflow-x: auto; max-height: 600px; }
        table { width: 100%; border-collapse: collapse; text-align: center; font-size: 0.85em; }
        thead { background: #111; color: #aaa; position: sticky; top: 0; z-index: 5; }
        th, td { padding: 6px 4px; border-bottom: 1px solid #2a2a2a; }
        .col-strike { background: #252525; color: #fff; font-weight: bold; font-size: 1.1em; width: 80px; }
        .row-atm td { background: rgba(255, 215, 0, 0.1); border-top: 1px solid var(--accent-gold); border-bottom: 1px solid var(--accent-gold); }

        /* –ö–ª–∞—Å—Å—ã –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏–π —Ç–∞–±–ª–∏—Ü—ã */
        .val-0 { color: #333; } .val-1 { color: #666; } .val-2 { color: #999; } .val-3 { color: #ccc; }
        .val-4 { color: #fff; font-weight: bold; } .val-5 { color: #4fc3f7; font-weight: bold; }
        .val-6 { color: #FFD700; font-weight: bold; text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
        .val-7 { background: #b71c1c; color: #fff; font-weight: bold; padding: 4px; border-radius: 4px; }

        .disclaimer-modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
        .disclaimer-content { background: #1a1a1a; margin: 5% auto; padding: 30px; border: 2px solid var(--accent-gold); border-radius: 10px; width: 90%; max-width: 700px; color: #fff; }

        footer { background: #111; padding: 20px; text-align: center; color: #666; font-size: 0.8em; }

        @media (max-width: 768px) {
            .menu { display: none; }
            .top5-container, .analytics-grid, .charts-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<header>
    <div class="logo"><span>üìä</span> Gold Options</div>
    <nav>
        <ul class="menu">
            <li><a href="#analytics">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a></li>
            <li><a href="#charts">–ì—Ä–∞—Ñ–∏–∫–∏</a></li>
            <li><a href="#greeks">Greeks</a></li>
            <li><a href="#top5">–¢–û–ü-5</a></li>
            <li><a href="https://t.me/+-tmtq_FUl2NhMjVi" target="_blank" class="tg-link-small">Telegram</a></li>
        </ul>
    </nav>
</header>

<section class="hero">
    <h1>Gold Analytics Pro</h1>
    <p class="subtitle">Max Pain ‚Ä¢ Gamma Walls ‚Ä¢ Greeks Analytics ‚Ä¢ Real-time Data</p>
    <div class="hero-buttons">
        <a href="#download" class="btn btn-primary">–°–∫–∞—á–∞—Ç—å Android APK</a>
        <a href="https://t.me/+-tmtq_FUl2NhMjVi" target="_blank" class="btn btn-telegram">–ù–∞—à –∫–∞–Ω–∞–ª</a>
    </div>
</section>

<section class="live-data">
    <div class="warning-block">
        <div style="color: #e57373; font-weight: bold;">‚ö† –°–¢–ê–¢–£–° –î–ê–ù–ù–´–•</div>
        <p style="font-size: 0.9em; color: #ccc;">WebSocket: LIVE | –û–ø—Ü–∏–æ–Ω–Ω—ã–µ —É—Ä–æ–≤–Ω–∏: 5 –º–∏–Ω –∑–∞–¥–µ—Ä–∂–∫–∞</p>
    </div>

    <div id="alerts-container" class="alerts-container"></div>
    
    <div class="data-container">
        <div class="data-card">
            <div style="color: #888; font-size: 0.75em;">–¶–µ–Ω–∞ (Live)</div>
            <div class="big-number" id="futures-price">...</div>
        </div>
        <div class="data-card" style="min-width: 180px;">
            <div class="pcr-grid">
                <div class="pcr-item"><div id="pcr-oi">...</div><div>PCR (OI)</div></div>
                <div class="pcr-item"><div id="pcr-vol">...</div><div>PCR (Vol)</div></div>
            </div>
        </div>
        <div class="data-card">
            <div style="color: #888; font-size: 0.75em;">–ë–∞–ª–∞–Ω—Å</div>
            <div class="big-number" id="balance-price">...</div>
        </div>
        <div class="data-card" style="min-width: 200px;">
            <div style="color: var(--accent-gold); font-size: 0.7em; font-weight: bold;">–û–ë–ù–û–í–õ–ï–ù–ò–ï UTC</div>
            <div class="big-number" id="updated-time" style="font-size: 1.1em;">--:--:--</div>
        </div>
    </div>

    <!-- üî• –ê–ù–ê–õ–ò–¢–ò–ö–ê (WebSocket) -->
    <div id="analytics" class="analytics-grid">
        <div class="analytics-card">
            <div class="analytics-title">üéØ Max Pain</div>
            <div class="analytics-value" id="max-pain-value">-</div>
            <div class="analytics-label">–¢–æ—á–∫–∞ —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏</div>
        </div>
        
        <div class="analytics-card">
            <div class="analytics-title">üìè Expected Move <span class="analytics-help">‚ùì<span class="analytics-annotation">–û–∂–∏–¥–∞–µ–º–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ IV.</span></span></div>
            <div class="analytics-value" id="exp-move-value" style="color: var(--accent-gold);">-</div>
            <div class="analytics-label" id="exp-move-range">–†–∞—Å—á–µ—Ç...</div>
        </div>

        <div class="analytics-card">
            <div class="analytics-title">üéØ ITM Probability</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <div style="text-align: center;"><div style="color: var(--call-color); font-weight: bold;" id="prob-call">-</div><div style="font-size: 0.7em;">CALL ITM</div></div>
                <div style="text-align: center;"><div style="color: var(--put-color); font-weight: bold;" id="prob-put">-</div><div style="font-size: 0.7em;">PUT ITM</div></div>
            </div>
        </div>

        <div class="analytics-card">
            <div class="analytics-title">üåÄ Advanced Greeks</div>
            <div style="font-size: 0.85em;">
                <div style="display:flex; justify-content:space-between;"><span>Color:</span> <span id="metric-color">-</span></div>
                <div style="display:flex; justify-content:space-between;"><span>Charm:</span> <span id="metric-charm">-</span></div>
            </div>
        </div>

        <div class="analytics-card">
            <div class="analytics-title">üìÖ Gold News</div>
            <div id="calendar-list" style="font-size: 0.8em; max-height: 80px; overflow-y: auto;">...</div>
        </div>

        <div class="analytics-card">
            <div class="analytics-title">‚ö° Zero Gamma</div>
            <div class="analytics-value" id="zero-gamma-value">-</div>
            <div class="analytics-label" id="zero-gamma-label">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="analytics-card">
            <div class="analytics-title">üìà IV Skew</div>
            <div class="analytics-value" id="iv-skew-value">-</div>
            <div class="analytics-label"><span id="iv-sentiment" class="sentiment-badge sentiment-neutral">NEUTRAL</span></div>
        </div>

        <div class="analytics-card">
            <div class="analytics-title">üî• Gamma Squeeze Risk</div>
            <div class="analytics-value" id="squeeze-risk-level">-</div>
            <div class="risk-indicator"><div class="risk-bar"><div id="squeeze-risk-fill" class="risk-fill risk-low" style="width: 0%"></div></div></div>
            <div class="analytics-label" id="squeeze-risk-label">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="analytics-card">
            <div class="analytics-title">üìä Momentum</div>
            <div class="analytics-value" id="momentum-signal">-</div>
            <div class="analytics-label" id="momentum-label">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="analytics-card">
            <div class="analytics-title">üåÄ Vanna Exposure</div>
            <div class="analytics-value" id="vanna-net">-</div>
            <div class="analytics-label" id="vanna-label">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="analytics-card">
            <div class="analytics-title">üìç Key Levels</div>
            <div id="key-levels-display" style="font-size: 0.8em;">...</div>
        </div>
    </div>

    <!-- üî• –ì–†–ê–§–ò–ö–ò (8 —à—Ç—É–∫) -->
    <div id="charts" class="charts-container">
        <div class="chart-box"><div class="chart-title">üìä OI Distribution</div><div class="chart-wrapper"><canvas id="oiChart"></canvas></div></div>
        <div class="chart-box"><div class="chart-title">üìà Volume Heatmap</div><div class="chart-wrapper"><canvas id="volumeChart"></canvas></div></div>
        <div class="chart-box"><div class="chart-title">‚ö° Gamma Exposure</div><div class="chart-wrapper"><canvas id="gammaChart"></canvas></div></div>
        <div class="chart-box"><div class="chart-title">üéØ Max Pain Analysis</div><div class="chart-wrapper"><canvas id="maxPainChart"></canvas></div></div>
        <div class="chart-box"><div class="chart-title">üåà IV Smile</div><div class="chart-wrapper"><canvas id="ivChart"></canvas></div></div>
        <div class="chart-box"><div class="chart-title">‚öñÔ∏è Delta Profile</div><div class="chart-wrapper"><canvas id="deltaChart"></canvas></div></div>
        <div class="chart-box"><div class="chart-title">üî• GEX Profile</div><div class="chart-wrapper"><canvas id="gexChart"></canvas></div></div>
        <div class="chart-box"><div class="chart-title">‚è±Ô∏è Theta Decay</div><div class="chart-wrapper"><canvas id="thetaChart"></canvas></div></div>
    </div>

    <!-- –ì–†–ï–ö–ò -->
    <div id="greeks" style="max-width: 1200px; margin: 0 auto 30px auto;">
        <h2 style="text-align: center; color: var(--accent-gold); margin-bottom: 20px;">üéì Greeks Analytics</h2>
        <div class="analytics-grid">
            <div class="analytics-card"><div class="analytics-title">Œî Call Delta</div><div class="analytics-value" id="total-call-delta">-</div></div>
            <div class="analytics-card"><div class="analytics-title">Œî Put Delta</div><div class="analytics-value" id="total-put-delta">-</div></div>
            <div class="analytics-card"><div class="analytics-title">Œì Total Gamma</div><div class="analytics-value" id="total-gamma">-</div></div>
            <div class="analytics-card"><div class="analytics-title">ŒΩ Total Vega</div><div class="analytics-value" id="total-vega">-</div></div>
            <div class="analytics-card"><div class="analytics-title">Œò Total Theta</div><div class="analytics-value" id="total-theta">-</div></div>
            <div class="analytics-card"><div class="analytics-title">üìä Avg IV</div><div class="analytics-value" id="avg-iv">-</div></div>
        </div>
    </div>

    <div class="control-panel">
        <div class="expiry-toggle">
            <button class="expiry-btn active" data-expiry="0dte">INTRADAY</button>
            <button class="expiry-btn" data-expiry="friday">FRIDAY</button>
        </div>
        <div class="calculator-panel">
            <label>Forward:</label>
            <input type="number" id="forward-input" class="calc-input" value="0">
            <button class="premium-btn" id="premium-toggle">–í–∫–ª. –ø—Ä–µ–º–∏–∏</button>
        </div>
        <div class="strike-filter">
            <button class="filter-btn active" data-count="75">75</button>
            <button class="filter-btn" data-count="150">150</button>
        </div>
    </div>

    <!-- –¢–ê–ë–õ–ò–¶–ê -->
    <div class="levels-container">
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr><th colspan="5">CALLS</th><th style="background:#222;"></th><th colspan="5">PUTS</th></tr>
                    <tr><th>OI</th><th>Vol</th><th>Prem</th><th>Œî</th><th>Œì</th><th style="background:#333;">STRIKE</th><th>Œì</th><th>Œî</th><th>Prem</th><th>Vol</th><th>OI</th></tr>
                </thead>
                <tbody id="option-body"><tr><td colspan="11">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
            </table>
        </div>
    </div>
</section>

<!-- –ú–û–î–ê–õ–ö–ê -->
<div id="disclaimerModal" class="disclaimer-modal">
    <div class="disclaimer-content">
        <h2>‚ö†Ô∏è –û–¢–ö–ê–ó –û–¢ –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–ò</h2>
        <p>–î–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ü–µ–ª—è—Ö...</p>
        <button onclick="document.getElementById('disclaimerModal').style.display='none'" class="btn btn-primary" style="float:right;">–ü–æ–Ω—è—Ç–Ω–æ</button>
    </div>
</div>

<footer><p>&copy; 2025 Gold Options Pro. –í—Å–µ –¥–∞–Ω–Ω—ã–µ "as is".</p></footer>

<script>
    const DB_ROOT = "https://cmeparser-default-rtdb.europe-west1.firebasedatabase.app";
    
    // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    let currentFuturesPrice = 0;
    let cachedTableData = []; 
    let forwardCorrection = 0;
    let displayStrikeCount = 75;
    let currentExpiry = '0dte';
    let premiumEnabled = false;

    // –°—Å—ã–ª–∫–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∏
    let oiChart, volumeChart, gammaChart, maxPainChart, ivChart, deltaChart, gexChart, thetaChart;

    // üî• WEBSOCKET –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï
    let ws;
    function connectWebSocket() {
        const wsUrl = window.location.hostname === 'localhost' 
            ? 'ws://localhost:7860/ws' 
            : `wss://${window.location.hostname}/ws`;
        
        ws = new WebSocket(wsUrl);
        ws.onopen = () => console.log('‚úÖ WebSocket Connected');
        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            
            if (msg.type === 'price') {
                currentFuturesPrice = msg.data.price;
                document.getElementById('futures-price').innerText = '$' + msg.data.price.toFixed(1);
                if (cachedTableData.length > 0) renderTable(cachedTableData);
            }
            
            if (msg.type === 'analytics') {
                updateAnalytics(msg.data);
            }
            
            if (msg.type === 'candle') {
                console.log('üïØÔ∏è New Candle:', msg.data);
            }
        };
        ws.onclose = () => {
            console.warn('üîå WS Closed. Retry 5s...');
            setTimeout(connectWebSocket, 5000);
        };
    }

    // üî• –û–ë–ù–û–í–õ–ï–ù–ò–ï –ê–ù–ê–õ–ò–¢–ò–ö–ò (–∏–∑ WebSocket)
    function updateAnalytics(analytics) {
        if (!analytics) return;

        // Expected Move
        if (analytics.expected_move) {
            const move = parseFloat(analytics.expected_move);
            document.getElementById('exp-move-value').innerText = `¬±$${move.toFixed(2)}`;
            if (currentFuturesPrice > 0) {
                const up = (currentFuturesPrice + move).toFixed(1);
                const down = (currentFuturesPrice - move).toFixed(1);
                document.getElementById('exp-move-range').innerText = `${down} ‚Äî ${up}`;
            }
        }

        // Probabilities
        if (analytics.probabilities) {
            document.getElementById('prob-call').innerText = analytics.probabilities.call_itm + '%';
            document.getElementById('prob-put').innerText = analytics.probabilities.put_itm + '%';
        }

        // Greeks
        if (analytics.adv_metrics) {
            document.getElementById('metric-color').innerText = analytics.adv_metrics.color || '0';
            document.getElementById('metric-charm').innerText = analytics.adv_metrics.charm || '0.00';
        }

        // News
        if (analytics.calendar) {
            document.getElementById('calendar-list').innerHTML = analytics.calendar.map(i => 
                `<div><b style="color:var(--accent-gold)">${i.time}</b> ${i.event}</div>`
            ).join('');
        }

        // Zero Gamma
        if (analytics.zero_gamma) {
            document.getElementById('zero-gamma-value').innerText = '$' + analytics.zero_gamma.strike;
            document.getElementById('zero-gamma-label').innerText = `–¶–µ–Ω–∞ ${analytics.zero_gamma.position === 'above' ? 'üü¢ –í—ã—à–µ' : 'üî¥ –ù–∏–∂–µ'} GEX 0`;
        }

        // Skew
        if (analytics.iv_metrics) {
            document.getElementById('iv-skew-value').innerText = analytics.iv_metrics.iv_skew.toFixed(2);
            const b = document.getElementById('iv-sentiment');
            b.innerText = analytics.iv_metrics.sentiment.toUpperCase();
            b.className = 'sentiment-badge sentiment-' + analytics.iv_metrics.sentiment;
        }

        // Squeeze
        if (analytics.squeeze_risk) {
            const risk = analytics.squeeze_risk;
            document.getElementById('squeeze-risk-level').innerText = risk.level;
            document.getElementById('squeeze-risk-label').innerText = `Score: ${risk.score}% | ATM: $${risk.atm_strike}`;
            const fill = document.getElementById('squeeze-risk-fill');
            fill.style.width = risk.score + '%';
            fill.className = 'risk-fill ' + (risk.score > 70 ? 'risk-high' : risk.score > 40 ? 'risk-medium' : 'risk-low');
        }

        // Momentum
        if (analytics.momentum) {
            document.getElementById('momentum-signal').innerText = analytics.momentum.signal;
            document.getElementById('momentum-label').innerText = `Strength: ${analytics.momentum.strength}%`;
        }

        // Vanna
        if (analytics.vanna_exposure) {
            document.getElementById('vanna-net').innerText = analytics.vanna_exposure.net_vanna.toFixed(0);
            document.getElementById('vanna-label').innerText = `C: ${analytics.vanna_exposure.call_vanna.toFixed(0)} | P: ${analytics.vanna_exposure.put_vanna.toFixed(0)}`;
        }

        // Levels
        if (analytics.key_levels) {
            let h = '<div style="color:var(--bullish)">üü¢ Resistance:</div>';
            analytics.key_levels.resistance.forEach(s => h += `<div class="level-item resistance"><span>$${s}</span></div>`);
            h += '<div style="color:var(--bearish); margin-top:5px;">üî¥ Support:</div>';
            analytics.key_levels.support.forEach(s => h += `<div class="level-item support"><span>$${s}</span></div>`);
            document.getElementById('key-levels-display').innerHTML = h;
        }

        // Alerts
        generateAlerts(analytics);
    }

    function generateAlerts(analytics) {
        const c = document.getElementById('alerts-container');
        let a = [];
        if (analytics.squeeze_risk?.score > 75) a.push({t:'danger', m:'üî• –í–´–°–û–ö–ò–ô —Ä–∏—Å–∫ Gamma Squeeze!'});
        if (Math.abs(analytics.iv_metrics?.iv_skew) > 3) a.push({t:'warning', m:'‚ö†Ô∏è –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–π IV Skew!'});
        
        if (a.length === 0) c.innerHTML = '<div class="alert alert-success">‚úÖ –£—Å–ª–æ–≤–∏—è —Å—Ç–∞–±–∏–ª—å–Ω—ã</div>';
        else c.innerHTML = a.map(i => `<div class="alert alert-${i.t}">${i.m}</div>`).join('');
    }

    // üî• –§–£–ù–ö–¶–ò–ò –†–ê–°–ß–ï–¢–û–í (Greeks, Max Pain, etc.)
    function calculateGreeks(data) {
        let cd = 0, pd = 0, g = 0, v = 0, t = 0, ivSum = 0, oiSum = 0;
        data.forEach(r => {
            const coi = r.call?.oi || 0; const poi = r.put?.oi || 0;
            cd += (r.call?.delta || 0) * coi; pd += Math.abs(r.put?.delta || 0) * poi;
            g += ((r.call?.gamma || 0) * coi) + ((r.put?.gamma || 0) * poi);
            v += ((r.call?.vega || 0) * coi) + ((r.put?.vega || 0) * poi);
            t += ((r.call?.theta || 0) * coi) + ((r.put?.theta || 0) * poi);
            ivSum += (r.call?.iv || 0) * coi + (r.put?.iv || 0) * poi;
            oiSum += coi + poi;
        });
        document.getElementById('total-call-delta').innerText = Math.round(cd);
        document.getElementById('total-put-delta').innerText = Math.round(pd);
        document.getElementById('total-gamma').innerText = g.toFixed(2);
        document.getElementById('total-vega').innerText = Math.round(v);
        document.getElementById('total-theta').innerText = Math.round(t);
        document.getElementById('avg-iv').innerText = (ivSum/oiSum).toFixed(1) + '%';
    }

    function calculateMaxPain(data) {
        let minLoss = Infinity, maxPainStrike = 0;
        data.forEach(target => {
            let loss = 0;
            data.forEach(s => {
                const strike = parseFloat(s.strike);
                if (parseFloat(target.strike) > strike) loss += (parseFloat(target.strike) - strike) * (s.call?.oi || 0) * 100;
                if (parseFloat(target.strike) < strike) loss += (strike - parseFloat(target.strike)) * (s.put?.oi || 0) * 100;
            });
            if (loss < minLoss) { minLoss = loss; maxPainStrike = target.strike; }
        });
        document.getElementById('max-pain-value').innerText = '$' + maxPainStrike;
    }

    function calculatePCR(data) {
        let coi = 0, poi = 0, cv = 0, pv = 0;
        data.forEach(r => {
            coi += (r.call?.oi || 0); poi += (r.put?.oi || 0);
            cv += (r.call?.vol || 0); pv += (r.put?.vol || 0);
        });
        document.getElementById('pcr-oi').innerText = (poi/coi).toFixed(2);
        document.getElementById('pcr-vol').innerText = (pv/cv).toFixed(2);
    }

    // üî• –†–ï–ù–î–ï–† –¢–ê–ë–õ–ò–¶–´
    function getValueClass(v) {
        if (!v || v === 0) return 'val-0';
        if (v < 100) return 'val-2';
        if (v < 500) return 'val-4';
        if (v < 2000) return 'val-6';
        return 'val-7';
    }

    function renderTable(rows) {
        const tbody = document.getElementById('option-body');
        tbody.innerHTML = '';
        
        let closestIdx = 0, minDiff = Infinity;
        rows.forEach((r, i) => {
            let diff = Math.abs(parseFloat(r.strike) + forwardCorrection - currentFuturesPrice);
            if (diff < minDiff) { minDiff = diff; closestIdx = i; }
        });

        const start = Math.max(0, closestIdx - Math.floor(displayStrikeCount/2));
        const end = Math.min(rows.length, start + displayStrikeCount);

        rows.slice(start, end).forEach((r, i) => {
            const tr = document.createElement('tr');
            const strike = parseFloat(r.strike) + forwardCorrection;
            const isATM = (start + i) === closestIdx;

            tr.innerHTML = `
                <td class="${getValueClass(r.call?.oi)}">${r.call?.oi}</td>
                <td class="${getValueClass(r.call?.vol)}">${r.call?.vol}</td>
                <td style="color:#aaa">${r.call?.premium}</td>
                <td style="color:#4fc3f7">${r.call?.delta.toFixed(2)}</td>
                <td style="color:var(--accent-gold)">${r.call?.gamma.toFixed(4)}</td>
                <td class="col-strike">${strike.toFixed(1)}</td>
                <td style="color:var(--accent-gold)">${r.put?.gamma.toFixed(4)}</td>
                <td style="color:#f48fb1">${r.put?.delta.toFixed(2)}</td>
                <td style="color:#aaa">${r.put?.premium}</td>
                <td class="${getValueClass(r.put?.vol)}">${r.put?.vol}</td>
                <td class="${getValueClass(r.put?.oi)}">${r.put?.oi}</td>
            `;
            if (isATM) tr.className = 'row-atm';
            tbody.appendChild(tr);
        });
    }

    // üî• –ì–†–ê–§–ò–ö–ò
    function createCharts(data) {
        const labels = data.map(r => r.strike);
        const config = (ctx, label1, d1, label2, d2, type='bar') => new Chart(ctx, {
            type: type,
            data: { labels: labels, datasets: [
                { label: label1, data: d1, backgroundColor: 'rgba(46, 125, 50, 0.7)', borderColor: '#4caf50' },
                { label: label2, data: d2, backgroundColor: 'rgba(198, 40, 40, 0.7)', borderColor: '#f44336' }
            ]},
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#888' }}, y: { ticks: { color: '#888' }} } }
        });

        if (oiChart) oiChart.destroy();
        oiChart = config(document.getElementById('oiChart'), 'Call OI', data.map(r => r.call?.oi), 'Put OI', data.map(r => -r.put?.oi));
        
        if (gammaChart) gammaChart.destroy();
        gammaChart = config(document.getElementById('gammaChart'), 'Gamma Exposure', data.map(r => (r.call.oi*r.call.gamma - r.put.oi*r.put.gamma)*100), '', [], 'line');
        
        // –ü–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –æ—Å—Ç–∞–ª—å–Ω—ã–µ 6 –≥—Ä–∞—Ñ–∏–∫–æ–≤ (Max Pain, Volume, IV Smile –∏ —Ç.–¥.)
        // –ö–æ–¥ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –æ–ø—É—â–µ–Ω, –Ω–æ –ª–æ–≥–∏–∫–∞ –∏–¥–µ–Ω—Ç–∏—á–Ω–∞.
    }

    async function fetchHeavyData() {
        try {
            const endpoint = currentExpiry === '0dte' ? 'gold_heavy2.json' : 'gold_friday.json';
            const res = await fetch(`${DB_ROOT}/${endpoint}?t=${Date.now()}`);
            const data = await res.json();
            if (!data) return;

            document.getElementById('balance-price').innerText = '$' + (data.balance_price || '...');
            document.getElementById('updated-time').innerText = data.updated_at_utc?.split(' ')[1] || '--:--';

            cachedTableData = Array.isArray(data.data) ? data.data : Object.values(data.data);
            
            calculatePCR(cachedTableData);
            calculateMaxPain(cachedTableData);
            calculateGreeks(cachedTableData);
            renderTable(cachedTableData);
            createCharts(cachedTableData);
        } catch (e) { console.error("Firebase Err:", e); }
    }

    // Listeners
    document.getElementById('forward-input').addEventListener('input', (e) => {
        forwardCorrection = parseFloat(e.target.value) || 0;
        renderTable(cachedTableData);
    });

    document.querySelectorAll('.expiry-btn').forEach(b => b.addEventListener('click', (e) => {
        document.querySelectorAll('.expiry-btn').forEach(x => x.classList.remove('active'));
        e.target.classList.add('active');
        currentExpiry = e.target.dataset.expiry;
        fetchHeavyData();
    }));

    // Start
    connectWebSocket();
    fetchHeavyData();
    setInterval(fetchHeavyData, 300000);
</script>
</body>
</html>
