<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold Options - Pro Analytics (Live)</title>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-gold: #FFD700;
            --call-color: #2e7d32;
            --put-color: #c62828;
            --strike-bg: #2c2c2c;
            --bullish: #4caf50;
            --bearish: #f44336;
            --neutral: #9e9e9e;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-color); }
        a { text-decoration: none; color: inherit; }
        
        /* –ü–û–î–°–ö–ê–ó–ö–ò */
        .chart-box, .analytics-card { position: relative; overflow: visible !important; z-index: 1; }
        .chart-title, .analytics-title {
            display: flex; justify-content: center; align-items: center; flex-wrap: wrap;
            position: relative; z-index: 10; font-size: 1.1em; font-weight: bold; color: var(--accent-gold);
            margin-bottom: 15px; text-align: center;
        }
        .chart-help, .analytics-help { position: relative; display: inline-block; cursor: help; margin-left: 8px; color: var(--accent-gold); }
        .chart-annotation, .analytics-annotation {
            visibility: hidden; opacity: 0; position: absolute; bottom: 140%; left: 50%; transform: translateX(-50%);
            width: 260px; background: rgba(15, 15, 15, 0.98); border: 1px solid var(--accent-gold);
            border-radius: 8px; padding: 12px 15px; color: #eee; font-size: 0.85rem; font-weight: normal; z-index: 9999;
        }
        .chart-help:hover .chart-annotation, .analytics-help:hover .analytics-annotation { visibility: visible; opacity: 1; }

        /* –î–ò–ó–ê–ô–ù –°–ï–ö–¶–ò–ô */
        header { background: #333; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .hero { background: linear-gradient(135deg, #000 0%, #434343 100%); padding: 40px 20px; text-align: center; }
        .hero h1 { color: var(--accent-gold); font-size: 2em; margin-bottom: 10px; }
        
        .live-data { padding: 20px; background: #000; }
        .data-container { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .data-card { background: #222; padding: 10px; border-radius: 8px; min-width: 140px; text-align: center; border: 1px solid #333; }
        .big-number { font-size: 1.3em; font-weight: bold; color: var(--accent-gold); }

        .analytics-grid { max-width: 1200px; margin: 0 auto 20px auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .analytics-card { background: #1a1a1a; border: 1px solid #444; border-radius: 10px; padding: 20px; border-left: 4px solid var(--accent-gold); }
        .analytics-value { font-size: 1.8em; font-weight: bold; text-align: center; margin: 10px 0; }
        
        .charts-container { max-width: 1200px; margin: 0 auto 30px auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-box { background: #1a1a1a; border: 1px solid #444; padding: 20px; border-radius: 10px; }
        .chart-wrapper { position: relative; height: 300px; }

        /* –¢–ê–ë–õ–ò–¶–ê */
        .levels-container { max-width: 1200px; margin: 0 auto; background: #1a1a1a; border-radius: 8px; border: 1px solid #333; }
        .table-wrapper { overflow-x: auto; max-height: 600px; }
        table { width: 100%; border-collapse: collapse; text-align: center; font-size: 0.85em; }
        thead { background: #111; position: sticky; top: 0; z-index: 5; }
        th, td { padding: 8px 4px; border-bottom: 1px solid #2a2a2a; }
        .col-strike { background: #252525; font-weight: bold; color: #fff; width: 80px; }
        .row-atm td { background: rgba(255, 215, 0, 0.1) !important; border-top: 1px solid var(--accent-gold); border-bottom: 1px solid var(--accent-gold); }

        /* –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
        .control-panel { max-width: 1000px; margin: 20px auto; background: #1a1a1a; padding: 20px; border-radius: 10px; display: flex; flex-direction: column; gap: 15px; }
        .btn { padding: 8px 16px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
        .active { background: var(--accent-gold) !important; color: #000 !important; }
        
        /* –¶–í–ï–¢–ê –ó–ù–ê–ß–ï–ù–ò–ô */
        .val-0 { color: #333; } .val-4 { color: #fff; font-weight: bold; } .val-6 { color: var(--accent-gold); font-weight: bold; text-shadow: 0 0 5px rgba(255,215,0,0.5); }
        .val-7 { background: #b71c1c; color: #fff; border-radius: 4px; }

        .sentiment-badge { padding: 4px 10px; border-radius: 10px; font-size: 0.8em; font-weight: bold; }
        .sentiment-bullish { background: var(--bullish); } .sentiment-bearish { background: var(--bearish); }
        
        .risk-bar { width: 100%; height: 10px; background: #333; border-radius: 5px; margin-top: 10px; overflow: hidden; }
        .risk-fill { height: 100%; transition: width 0.5s; }
        
        .alert { padding: 10px; border-radius: 5px; margin-bottom: 10px; font-weight: bold; text-align: center; }
        .alert-danger { background: rgba(244,67,54,0.2); color: #ff8a80; border: 1px solid #f44336; }
        .alert-success { background: rgba(76,175,80,0.2); color: #b9f6ca; border: 1px solid #4caf50; }

        @media (max-width: 768px) { .charts-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header>
    <div style="font-size: 1.5em; font-weight: bold; color: #fff;">üìä Gold Options Live</div>
    <div style="background: #24A1DE; padding: 5px 12px; border-radius: 15px; font-size: 0.8em;">Telegram Online</div>
</header>

<section class="hero">
    <h1>Gold Analytics Pro</h1>
    <p style="opacity: 0.8;">WebSocket Real-time Data ‚Ä¢ Gamma Walls ‚Ä¢ Greeks</p>
</section>

<section class="live-data">
    <div id="alerts-container" class="max-width: 1200px; margin: 0 auto;"></div>

    <div class="data-container">
        <div class="data-card">
            <div style="font-size: 0.8em; color: #888;">–¶–µ–Ω–∞ (Live)</div>
            <div class="big-number" id="futures-price">...</div>
        </div>
        <div class="data-card">
            <div style="font-size: 0.8em; color: #888;">PCR (OI / Vol)</div>
            <div style="font-weight: bold;"><span id="pcr-oi">...</span> / <span id="pcr-vol">...</span></div>
        </div>
        <div class="data-card">
            <div style="font-size: 0.8em; color: #888;">–ë–∞–ª–∞–Ω—Å</div>
            <div class="big-number" id="balance-price">...</div>
        </div>
        <div class="data-card">
            <div style="font-size: 0.8em; color: #888;">–û–±–Ω–æ–≤–ª–µ–Ω–æ</div>
            <div id="updated-time" style="font-size: 0.9em;">...</div>
        </div>
    </div>

    <!-- –ê–ù–ê–õ–ò–¢–ò–ö–ê -->
    <div class="analytics-grid">
        <div class="analytics-card">
            <div class="analytics-title">üéØ Max Pain</div>
            <div class="analytics-value" id="max-pain-value">-</div>
        </div>
        <div class="analytics-card">
            <div class="analytics-title">üìè Expected Move</div>
            <div class="analytics-value" id="exp-move-value">-</div>
            <div id="exp-move-range" style="text-align: center; color: #888; font-size: 0.9em;">...</div>
        </div>
        <div class="analytics-card">
            <div class="analytics-title">‚ö° Zero Gamma</div>
            <div class="analytics-value" id="zero-gamma-value">-</div>
            <div id="zero-gamma-label" style="text-align: center; font-size: 0.8em;">...</div>
        </div>
        <div class="analytics-card">
            <div class="analytics-title">üìà IV Skew</div>
            <div class="analytics-value" id="iv-skew-value">-</div>
            <div style="text-align: center;"><span id="iv-sentiment" class="sentiment-badge">...</span></div>
        </div>
        <div class="analytics-card">
            <div class="analytics-title">üî• Squeeze Risk</div>
            <div class="analytics-value" id="squeeze-risk-level">-</div>
            <div class="risk-bar"><div id="squeeze-risk-fill" class="risk-fill" style="width: 0%"></div></div>
            <div id="squeeze-risk-label" style="text-align: center; font-size: 0.7em; margin-top: 5px;">...</div>
        </div>
        <div class="analytics-card">
            <div class="analytics-title">üìç Key Levels</div>
            <div id="key-levels-display"></div>
        </div>
    </div>

    <!-- –ì–†–ê–§–ò–ö–ò -->
    <div class="charts-container">
        <div class="chart-box">
            <div class="chart-title">üìä OI Distribution</div>
            <div class="chart-wrapper"><canvas id="oiChart"></canvas></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">‚ö° Gamma Exposure</div>
            <div class="chart-wrapper"><canvas id="gammaChart"></canvas></div>
        </div>
    </div>

    <!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï -->
    <div class="control-panel">
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn active expiry-btn" data-expiry="0dte">INTRADAY</button>
            <button class="btn expiry-btn" data-expiry="friday">FRIDAY</button>
        </div>
        <div style="text-align: center;">
            <label>–§–æ—Ä–≤–∞—Ä–¥:</label>
            <input type="number" id="forward-input" value="0" style="width: 60px; background: #222; color: #fff; border: 1px solid #555; padding: 5px;">
            <button id="premium-toggle" class="btn" style="background: #444; color: #fff; margin-left: 10px;">–ü—Ä–µ–º–∏–∏: –í–´–ö–õ</button>
        </div>
    </div>

    <!-- –¢–ê–ë–õ–ò–¶–ê -->
    <div class="levels-container">
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th colspan="5" style="color: var(--bullish)">CALLS</th>
                        <th></th>
                        <th colspan="5" style="color: var(--bearish)">PUTS</th>
                    </tr>
                    <tr>
                        <th>OI</th><th>Vol</th><th>Prem</th><th>Œî</th><th>Œì</th>
                        <th style="background: #333;">STRIKE</th>
                        <th>Œì</th><th>Œî</th><th>Prem</th><th>Vol</th><th>OI</th>
                    </tr>
                </thead>
                <tbody id="option-body">
                    <tr><td colspan="11">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</section>

<script>
    const DB_ROOT = "https://cmeparser-default-rtdb.europe-west1.firebasedatabase.app";
    
    // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    let currentFuturesPrice = 0;
    let cachedTableData = []; 
    let forwardCorrection = 0;
    let displayStrikeCount = 75;
    let currentExpiry = '0dte';
    let premiumEnabled = false;

    // –ì—Ä–∞—Ñ–∏–∫–∏
    let oiChart, gammaChart;

    // üî• WEBSOCKET –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï
    let ws;
    function connectWebSocket() {
        const wsUrl = window.location.hostname === 'localhost' 
            ? 'ws://localhost:7860/ws' 
            : `wss://${window.location.hostname}/ws`;
        
        console.log('üì° WebSocket connect to:', wsUrl);
        ws = new WebSocket(wsUrl);
        
        ws.onopen = () => console.log('‚úÖ WebSocket Connected');
        
        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            
            if (msg.type === 'price') {
                currentFuturesPrice = msg.data.price;
                document.getElementById('futures-price').innerText = '$' + msg.data.price.toFixed(1);
                if (cachedTableData.length > 0) renderTable(cachedTableData);
            }
            
            if (msg.type === 'analytics') {
                updateAnalytics(msg.data);
            }
        };
        
        ws.onclose = () => {
            console.warn('üîå WS Closed. Reconnecting...');
            setTimeout(connectWebSocket, 5000);
        };
    }

    // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ê–ù–ê–õ–ò–¢–ò–ö–ò
    function updateAnalytics(analytics) {
        if (!analytics) return;

        if (analytics.expected_move) {
            const move = parseFloat(analytics.expected_move);
            document.getElementById('exp-move-value').innerText = `¬±$${move.toFixed(2)}`;
            if (currentFuturesPrice > 0) {
                const up = (currentFuturesPrice + move).toFixed(1);
                const down = (currentFuturesPrice - move).toFixed(1);
                document.getElementById('exp-move-range').innerText = `${down} ‚Äî ${up}`;
            }
        }

        if (analytics.zero_gamma) {
            document.getElementById('zero-gamma-value').innerText = '$' + analytics.zero_gamma.strike;
            document.getElementById('zero-gamma-label').innerText = `–¶–µ–Ω–∞ ${analytics.zero_gamma.position === 'above' ? '–í—ã—à–µ' : '–ù–∏–∂–µ'} GEX 0`;
        }

        if (analytics.iv_metrics) {
            document.getElementById('iv-skew-value').innerText = analytics.iv_metrics.iv_skew.toFixed(2);
            const badge = document.getElementById('iv-sentiment');
            badge.innerText = analytics.iv_metrics.sentiment.toUpperCase();
            badge.className = `sentiment-badge sentiment-${analytics.iv_metrics.sentiment}`;
        }

        if (analytics.squeeze_risk) {
            const risk = analytics.squeeze_risk;
            document.getElementById('squeeze-risk-level').innerText = risk.level;
            document.getElementById('squeeze-risk-label').innerText = `Score: ${risk.score}% | ATM: $${risk.atm_strike}`;
            const fill = document.getElementById('squeeze-risk-fill');
            fill.style.width = risk.score + '%';
            fill.style.background = risk.score > 70 ? 'var(--bearish)' : risk.score > 40 ? '#ff9800' : 'var(--bullish)';
        }

        if (analytics.key_levels) {
            let html = '<div style="color:var(--bullish); font-size:0.8em; margin-bottom:5px;">Resistance:</div>';
            analytics.key_levels.resistance.forEach(s => html += `<div style="background:#222; margin:2px; padding:3px;">$${s}</div>`);
            html += '<div style="color:var(--bearish); font-size:0.8em; margin:10px 0 5px 0;">Support:</div>';
            analytics.key_levels.support.forEach(s => html += `<div style="background:#222; margin:2px; padding:3px;">$${s}</div>`);
            document.getElementById('key-levels-display').innerHTML = html;
        }

        // Alerts
        const alertsContainer = document.getElementById('alerts-container');
        if (analytics.squeeze_risk && analytics.squeeze_risk.score > 75) {
            alertsContainer.innerHTML = '<div class="alert alert-danger">‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ Gamma Squeeze!</div>';
        } else {
            alertsContainer.innerHTML = '<div class="alert alert-success">‚úÖ –†—ã–Ω–æ—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è —Å—Ç–∞–±–∏–ª—å–Ω—ã</div>';
        }
    }

    // –¢–Ø–ñ–ï–õ–´–ï –î–ê–ù–ù–´–ï (FIREBASE)
    async function fetchHeavyData() {
        try {
            const endpoint = currentExpiry === '0dte' ? 'gold_heavy2.json' : 'gold_friday.json';
            const res = await fetch(`${DB_ROOT}/${endpoint}?t=${Date.now()}`);
            const data = await res.json();
            if (!data || !data.data) return;

            document.getElementById('balance-price').innerText = '$' + (data.balance_price || '...');
            document.getElementById('updated-time').innerText = data.updated_at_utc || '...';

            cachedTableData = Array.isArray(data.data) ? data.data : Object.values(data.data);
            
            calculatePCR(cachedTableData);
            calculateMaxPain(cachedTableData);
            createCharts(cachedTableData);
            renderTable(cachedTableData);
        } catch (e) { console.error("Firebase Error:", e); }
    }

    // –§–£–ù–ö–¶–ò–ò –†–ê–°–ß–ï–¢–û–í
    function calculatePCR(rows) {
        let calls = 0, puts = 0, vCalls = 0, vPuts = 0;
        rows.forEach(r => {
            calls += (r.call?.oi || 0); puts += (r.put?.oi || 0);
            vCalls += (r.call?.vol || 0); vPuts += (r.put?.vol || 0);
        });
        document.getElementById('pcr-oi').innerText = (puts/calls).toFixed(2);
        document.getElementById('pcr-vol').innerText = (vPuts/vCalls).toFixed(2);
    }

    function calculateMaxPain(data) {
        let minLoss = Infinity, strike = 0;
        data.forEach(target => {
            let loss = 0;
            data.forEach(s => {
                const s_strike = parseFloat(s.strike);
                const t_strike = parseFloat(target.strike);
                if (t_strike > s_strike) loss += (t_strike - s_strike) * (s.call?.oi || 0);
                if (t_strike < s_strike) loss += (s_strike - t_strike) * (s.put?.oi || 0);
            });
            if (loss < minLoss) { minLoss = loss; strike = target.strike; }
        });
        document.getElementById('max-pain-value').innerText = '$' + strike;
    }

    function renderTable(rows) {
        const tbody = document.getElementById('option-body');
        tbody.innerHTML = '';
        
        let closestIdx = 0, minDiff = Infinity;
        rows.forEach((r, i) => {
            let diff = Math.abs(parseFloat(r.strike) + forwardCorrection - currentFuturesPrice);
            if (diff < minDiff) { minDiff = diff; closestIdx = i; }
        });

        const start = Math.max(0, closestIdx - 35);
        const end = Math.min(rows.length, start + 70);
        
        rows.slice(start, end).forEach(row => {
            const tr = document.createElement('tr');
            const strike = parseFloat(row.strike) + forwardCorrection;
            const isATM = Math.abs(strike - currentFuturesPrice) < 1.0;
            
            tr.innerHTML = `
                <td class="${row.call?.oi > 1000 ? 'val-6' : ''}">${row.call?.oi}</td>
                <td>${row.call?.vol}</td>
                <td style="color:#aaa">${row.call?.premium}</td>
                <td style="color:#4fc3f7">${row.call?.delta.toFixed(2)}</td>
                <td style="color:var(--accent-gold)">${row.call?.gamma.toFixed(4)}</td>
                <td class="col-strike">${strike.toFixed(1)}</td>
                <td style="color:var(--accent-gold)">${row.put?.gamma.toFixed(4)}</td>
                <td style="color:#f48fb1">${row.put?.delta.toFixed(2)}</td>
                <td style="color:#aaa">${row.put?.premium}</td>
                <td>${row.put?.vol}</td>
                <td class="${row.put?.oi > 1000 ? 'val-6' : ''}">${row.put?.oi}</td>
            `;
            if (isATM) tr.className = 'row-atm';
            tbody.appendChild(tr);
        });
    }

    function createCharts(data) {
        const labels = data.map(r => r.strike);
        const ctxOI = document.getElementById('oiChart').getContext('2d');
        if (oiChart) oiChart.destroy();
        oiChart = new Chart(ctxOI, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Call OI', data: data.map(r => r.call?.oi), backgroundColor: 'rgba(76, 175, 80, 0.7)' },
                    { label: 'Put OI', data: data.map(r => -(r.put?.oi)), backgroundColor: 'rgba(244, 67, 54, 0.7)' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { beginAtZero: true } } }
        });
    }

    // LISTENERS
    document.querySelectorAll('.expiry-btn').forEach(b => b.addEventListener('click', (e) => {
        document.querySelectorAll('.expiry-btn').forEach(x => x.classList.remove('active'));
        e.target.classList.add('active');
        currentExpiry = e.target.dataset.expiry;
        fetchHeavyData();
    }));

    document.getElementById('forward-input').addEventListener('input', (e) => {
        forwardCorrection = parseFloat(e.target.value) || 0;
        renderTable(cachedTableData);
    });

    // START
    connectWebSocket();
    fetchHeavyData();
    setInterval(fetchHeavyData, 300000);
</script>

</body>
</html>
